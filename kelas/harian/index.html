<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kuis Supabase</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      color: #333;
      padding: 20px;
    }
    #quiz-ui, #results-ui {
      max-width: 600px;
      margin: auto;
      padding: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    #question-text {
      font-size: 1.2rem;
      margin-bottom: 20px;
    }
    ul#options-list {
      list-style: none;
      padding: 0;
    }
    .option-item {
      padding: 12px 16px;
      margin-bottom: 10px;
      border: 2px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .option-item:hover { background-color: #e0f0ff; }
    .option-item.selected { background-color: #cce5ff; border-color: #3399ff; }
    .option-item.correct { background-color: #d4edda; border-color: #28a745; }
    .option-item.incorrect { background-color: #f8d7da; border-color: #dc3545; }
    #next-button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background-color: #3399ff;
      color: white;
    }
    #next-button:disabled { background-color: #ccc; cursor: not-allowed; }
    #status-message, #save-status-message {
      margin-top: 12px;
      padding: 10px;
      border-radius: 8px;
      font-weight: bold;
      text-align: center;
      display: none;
    }
  </style>
</head>
<body>

  <!-- --- BAGIAN QUIZ --- -->
  <div id="quiz-ui">
    <div id="question-text">Memuat soal...</div>
    <ul id="options-list"></ul>
    <button id="next-button">Selanjutnya</button>
    <div id="timer"></div>
    <div id="status-message"></div>
    <div id="save-status-message"></div>
  </div>

  <!-- --- BAGIAN HASIL --- -->
  <div id="results-ui" style="display:none;">
    <h2>Hasil Kuis</h2>
    <p>Skor Anda: <span id="final-score"></span></p>
    <p id="score-message"></p>
  </div>

  <!-- --- BAGIAN JS --- -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // --- KONFIGURASI SUPABASE ---
    const SUPABASE_URL = "https://jpxtbdawajjyrvqrgijd.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_ANON_KEY_HERE"; // ganti dengan key Supabase

    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- ELEMENT DOM ---
    const quizUI = document.getElementById('quiz-ui');
    const resultsUI = document.getElementById('results-ui');
    const questionText = document.getElementById('question-text');
    const optionsList = document.getElementById('options-list');
    const nextButton = document.getElementById('next-button');
    const finalScoreSpan = document.getElementById('final-score');
    const scoreMessage = document.getElementById('score-message');
    const statusMessage = document.getElementById('status-message');
    const saveStatusMessage = document.getElementById('save-status-message');
    const timerEl = document.getElementById('timer');

    let quizData = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let selectedOption = null;
    let questionStartTime = null;
    let timerInterval = null;

    // --- FETCH SOAL DARI SUPABASE ---
    async function loadQuizFromSupabase() {
      const { data, error } = await supabaseClient
        .from('dashboard_quiz_questions')
        .select('id, question_text, options, correct_answer')
        .limit(10);

      if (error) {
        console.error('Gagal fetch kuis:', error);
        questionText.textContent = 'Gagal memuat kuis.';
        return;
      }

      quizData = data.map(q => ({
        id: q.id,
        question_text: q.question_text,
        options: Object.entries(q.options).map(([key, value]) => ({ key, value })),
        correct_answer: q.correct_answer
      }));

      currentQuestionIndex = 0;
      score = 0;
      loadQuestion();
    }

    // --- TIMER ---
    function startTimer() {
      questionStartTime = Date.now();
      timerEl.textContent = '';
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - questionStartTime) / 1000);
        timerEl.textContent = `Waktu: ${elapsed} detik`;
      }, 500);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      return Math.floor((Date.now() - questionStartTime) / 1000);
    }

    // --- LOAD SOAL ---
    function loadQuestion() {
      selectedOption = null;
      hideStatusMessage();
      saveStatusMessage.style.display = 'none';
      timerEl.textContent = '';

      if (currentQuestionIndex >= quizData.length) {
        showResults();
        return;
      }

      const currentQuestion = quizData[currentQuestionIndex];
      questionText.textContent = `${currentQuestionIndex + 1}. ${currentQuestion.question_text}`;
      optionsList.innerHTML = '';

      currentQuestion.options.forEach(opt => {
        const li = document.createElement('li');
        li.textContent = opt.value;
        li.dataset.optionKey = opt.key;
        li.className = 'option-item';
        li.addEventListener('click', () => {
          document.querySelectorAll('.option-item').forEach(item => item.classList.remove('selected'));
          li.classList.add('selected');
          selectedOption = opt.key;
        });
        optionsList.appendChild(li);
      });

      nextButton.textContent = currentQuestionIndex === quizData.length - 1 ? 'Selesai' : 'Selanjutnya';
      optionsList.classList.remove('no-pointer-events');
      nextButton.disabled = false;
      startTimer();
    }

    // --- STATUS MESSAGE ---
    function showStatusMessage(message, textColor = 'text-black', bgColor = 'bg-gray-200') {
      statusMessage.textContent = message;
      statusMessage.className = `mt-4 p-3 rounded-lg text-sm font-semibold text-center ${textColor} ${bgColor}`;
      statusMessage.style.display = 'block';
    }

    function hideStatusMessage() {
      statusMessage.style.display = 'none';
    }

    function showSaveStatusMessage(message, textColor, bgColor) {
      saveStatusMessage.textContent = message;
      saveStatusMessage.className = `mt-4 p-3 rounded-lg text-sm font-semibold text-center ${textColor} ${bgColor}`;
      saveStatusMessage.style.display = 'block';
    }

    // --- SUBMIT JAWABAN ---
    async function submitAnswer(currentQuestion, timeTakenSec) {
      const { data: { user } } = await supabaseClient.auth.getUser();

      if (!user) {
        showSaveStatusMessage('Anda belum masuk untuk menyimpan skor.', 'text-orange-800', 'bg-orange-100');
        return;
      }

      const isCorrect = selectedOption === currentQuestion.correct_answer;
      const scoreThis = isCorrect ? 10 : 0;

      const { error } = await supabaseClient
        .from('dashboard_quiz_attempts')
        .insert([{
          user_id: user.id,
          quiz_question_id: currentQuestion.id,
          selected_answer: selectedOption,
          score: scoreThis,
          is_correct: isCorrect,
          time_taken: `${timeTakenSec} seconds`,
          submitted_at: new Date().toISOString()
        }]);

      if (error) {
        console.error('Gagal menyimpan jawaban:', error);
        showSaveStatusMessage('Gagal menyimpan jawaban.', 'text-red-800', 'bg-red-100');
      } else {
        showSaveStatusMessage('Jawaban berhasil dicatat!', 'text-green-800', 'bg-green-100');
      }
    }

    // --- FEEDBACK & LANJUT SOAL ---
    function giveFeedback() {
      optionsList.classList.add('no-pointer-events');
      nextButton.disabled = true;
      const currentQuestion = quizData[currentQuestionIndex];
      const selectedLi = document.querySelector('.option-item.selected');
      const timeTakenSec = stopTimer();

      if (!selectedLi) return;

      const isCorrect = selectedOption === currentQuestion.correct_answer;
      if (isCorrect) {
        score += 10;
        selectedLi.classList.add('correct');
        showStatusMessage('Jawaban Benar!', 'text-green-800', 'bg-green-100');
      } else {
        selectedLi.classList.add('incorrect');
        showStatusMessage('Jawaban salah.', 'text-red-800', 'bg-red-100');
      }

      submitAnswer(currentQuestion, timeTakenSec);

      setTimeout(() => {
        currentQuestionIndex++;
        loadQuestion();
      }, 1500);
    }

    // --- TAMPILKAN HASIL ---
    function showResults() {
      quizUI.style.display = 'none';
      resultsUI.style.display = 'block';
      finalScoreSpan.textContent = score;

      if (score === quizData.length * 10) {
        scoreMessage.textContent = 'Masya Allah! Skor sempurna!';
      } else if (score >= quizData.length * 7) {
        scoreMessage.textContent = 'Kerja bagus! Anda lulus kuis.';
      } else {
        scoreMessage.textContent = 'Coba lagi, jangan menyerah!';
      }
    }

    // --- EVENT NEXT BUTTON ---
    nextButton.addEventListener('click', () => {
      if (!selectedOption) {
        showStatusMessage('Pilih jawaban terlebih dahulu.', 'text-red-800', 'bg-red-100');
        return;
      }
      giveFeedback();
    });

    document.addEventListener('DOMContentLoaded', loadQuizFromSupabase);

  </script>
</body>
</html>