<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin Kuis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #111827; color: #d1d5db; font-family: 'Inter', sans-serif; }
        .kpi-card { background-color: #1f2937; border: 1px solid #374151; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1); }
        @import url('https://rsms.me/inter/inter.css');
    </style>
</head>
<body class="antialiased">

    <header class="bg-gray-800 shadow-md p-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-2xl font-bold text-white flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20V16"/></svg>
                Dashboard Admin Kuis
            </h1>
        </div>
    </header>

    <main class="p-4 sm:p-6 md:p-8 max-w-7xl mx-auto">
        <div id="loading-state" class="text-center py-20">
            <svg class="animate-spin h-8 w-8 text-blue-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-4 text-lg text-gray-400">Memuat data dari Supabase...</p>
        </div>
        <div id="main-content" class="hidden">
            <section class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8">
                <a href="users/" class="kpi-card rounded-lg p-6 block">
                    <h3 class="text-sm font-medium text-gray-400">Total Pengguna</h3>
                    <p id="total-users" class="text-3xl font-bold text-white mt-2">0</p>
                </a>
                <div class="kpi-card rounded-lg p-6">
                    <h3 class="text-sm font-medium text-gray-400">Kuis Dikerjakan Hari Ini</h3>
                    <p id="quiz-attempts-today" class="text-3xl font-bold text-white mt-2">0</p>
                </div>
            </section>
            <section class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
                <div class="lg:col-span-3 bg-gray-800 border border-gray-700 rounded-lg p-6">
                    <h3 class="font-semibold text-white mb-4">üèÜ Leaderboard - Top 10 Pengguna</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-300">
                            <thead class="text-xs text-gray-400 uppercase bg-gray-700/50">
                                <tr>
                                    <th scope="col" class="py-3 px-6">Peringkat</th>
                                    <th scope="col" class="py-3 px-6">Pengguna</th>
                                    <th scope="col" class="py-3 px-6">Total Skor</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="lg:col-span-2 bg-gray-800 border border-gray-700 rounded-lg p-6 h-96">
                    <h3 class="font-semibold text-white mb-4">Kuis Terpopuler</h3>
                    <div class="relative h-full w-full flex items-center justify-center">
                        <canvas id="popular-quizzes-chart"></canvas>
                    </div>
                </div>
            </section>
            <section>
                <h3 class="text-xl font-semibold text-white mb-4">Aktivitas Terbaru</h3>
                <div class="bg-gray-800 border border-gray-700 rounded-lg overflow-hidden">
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-400 uppercase bg-gray-700/50">
                            <tr>
                                <th scope="col" class="py-3 px-6">Pengguna</th>
                                <th scope="col" class="py-3 px-6">Nama Kuis</th>
                                <th scope="col" class="py-3 px-6">Skor</th>
                                <th scope="col" class="py-3 px-6">Waktu</th>
                            </tr>
                        </thead>
                        <tbody id="recent-activity-body"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = "https://jpxtbdawajjyrvqrgijd.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpweHRiZGF3YWpqeXJ2cXJnaWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTI4OTgsImV4cCI6MjA3MTg4ODg5OH0.vEqCzHYBByFZEXeLIBqx6b40x6-tjSYa3Il_b2mI9NE";

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const quizNameMap = {
            'kelas01_bab01_hijaiyah': 'Kuis Hijaiyah Bab 1',
        };

        async function fetchTotalUsers() {
            const { count, error } = await supabase.from('profiles').select('*', { count: 'exact', head: true });
            if (error) console.error('Error fetching total users:', error.message);
            return count || 0;
        }

        async function fetchQuizAttemptsToday() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const { count, error } = await supabase.from('quiz_attempts').select('*', { count: 'exact', head: true }).gte('submitted_at', today.toISOString());
            if (error) console.error('Error fetching quiz attempts:', error.message);
            return count || 0;
        }
        
        async function fetchLeaderboardData() {
            const { data, error } = await supabase.from('leaderboard').select('rank, username, total_score').limit(10);
            if (error) console.error('Error fetching leaderboard:', error.message);
            return data || [];
        }

        async function fetchPopularQuizzes() {
            const { data, error } = await supabase.from('quiz_attempts').select('quiz_id');
            if (error) {
                console.error('Error fetching popular quizzes:', error.message);
                return { labels: [], data: [] };
            }
            const quizCounts = data.reduce((acc, item) => {
                const quizName = quizNameMap[item.quiz_id] || item.quiz_id;
                acc[quizName] = (acc[quizName] || 0) + 1;
                return acc;
            }, {});
            const sortedQuizzes = Object.entries(quizCounts).sort(([,a],[,b]) => b-a).slice(0, 5);
            return { labels: sortedQuizzes.map(item => item[0]), data: sortedQuizzes.map(item => item[1]) };
        }

        // --- REVISI KUNCI: MENGAMBIL DATA DARI VIEW 'latest_activity' ---
        async function fetchRecentActivities() {
            const { data, error } = await supabase
                .from('latest_activity') // Mengambil dari VIEW, bukan 'quiz_attempts'
                .select('*')
                .limit(5); // Batasi 5 aktivitas teratas
            if(error) console.error('Error fetching recent activities:', error.message);
            return data || [];
        }

        function createChart(ctx, type, labels, data, label, backgroundColor) {
             new Chart(ctx, { type, data: { labels, datasets: [{ label, data, backgroundColor, borderWidth: type === 'doughnut' ? 0 : 1, tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: type !== 'doughnut', beginAtZero: true, ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }, x: { display: type !== 'doughnut', ticks: { color: '#9ca3af' }, grid: { color: '#374151' } } }, plugins: { legend: { labels: { color: '#d1d5db' } } } } });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');

            const [
                totalUsers, attemptsToday,
                leaderboardData, popularQuizData, recentActivities
            ] = await Promise.all([
                fetchTotalUsers(), fetchQuizAttemptsToday(),
                fetchLeaderboardData(), fetchPopularQuizzes(), fetchRecentActivities()
            ]);

            document.getElementById('total-users').textContent = totalUsers;
            document.getElementById('quiz-attempts-today').textContent = attemptsToday;

            const leaderboardTable = document.getElementById('leaderboard-body');
            leaderboardTable.innerHTML = leaderboardData.length > 0
                ? leaderboardData.map(user => `
                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                        <td class="py-3 px-6 font-medium">${user.rank}</td>
                        <td class="py-3 px-6">${user.username}</td>
                        <td class="py-3 px-6 text-lg font-bold text-amber-400">${user.total_score || 0}</td>
                    </tr>
                `).join('')
                : `<tr><td colspan="3" class="py-4 px-6 text-center text-gray-400">Belum ada data skor.</td></tr>`;

            const quizCtx = document.getElementById('popular-quizzes-chart').getContext('2d');
            createChart(quizCtx, 'doughnut', popularQuizData.labels, popularQuizData.data, 'Pengerjaan', ['#10b981', '#3b82f6', '#ef4444', '#f97316', '#8b5cf6']);
            
            // --- REVISI KUNCI: MENAMPILKAN DATA DARI VIEW 'latest_activity' ---
            const activityTable = document.getElementById('recent-activity-body');
            activityTable.innerHTML = recentActivities.length > 0
                ? recentActivities.map(act => `
                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                        <td class="py-4 px-6">${act.username || 'Tanpa Nama'}</td>
                        <td class="py-4 px-6 capitalize">${quizNameMap[act.quiz_id] || act.quiz_id}</td>
                        <td class="py-4 px-6 font-medium text-emerald-400">${act.score}</td>
                        <td class="py-4 px-6 text-sm text-gray-400">${new Date(act.submitted_at).toLocaleString('id-ID')}</td>
                    </tr>
                `).join('')
                : `<tr><td colspan="4" class="py-4 px-6 text-center text-gray-400">Belum ada aktivitas.</td></tr>`;
        });
    </script>
</body>
</html>
