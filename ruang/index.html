<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Belajar Ngaji</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
@import url('https://rsms.me/inter/inter.css');
body { font-family: 'Inter', sans-serif; background-color: #f0f8ff; color: #1f2937; margin:0; overflow-x:hidden; }
.kpi-card { background:white; border:1px solid #e2e8f0; border-radius:.5rem; transition: transform .2s, box-shadow .2s;}
.kpi-card:hover { transform: translateY(-3px); box-shadow:0 6px 10px rgba(0,0,0,.1);}
.sidebar { background:white; border-right:1px solid #e2e8f0;}
.sidebar a { display:block; color:#1e3a8a; transition: all .2s; padding:.5rem 0; border-radius: .25rem; padding-left: 1rem;}
.sidebar a:hover, .sidebar a.active { background-color: #eff6ff; color:#2563eb; font-weight:600; }
.correct { background-color:#d1fae5;}
.wrong { background-color:#fee2e2;}
.overflow-x-auto { overflow-x:auto;}
table { border-collapse:collapse; width:100%; min-width:600px;}
*, *::before, *::after { box-sizing:border-box; max-width:100%; }
header { position:sticky; top:0; z-index:10; }
#overlay { position:fixed; inset:0; background:rgba(0,0,0,.3); z-index:20; display:none;}
.loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body class="antialiased flex">

<!-- Sidebar -->
<aside id="sidebar" class="sidebar fixed top-0 left-0 h-full w-64 bg-white shadow-lg transform -translate-x-full lg:translate-x-0 transition-transform duration-300 z-30">
<div class="p-6">
  <h2 class="text-xl font-bold mb-6 text-blue-600">Menu Admin</h2>
  <ul class="space-y-2">
    <li><a href="#" class="active">Dashboard</a></li>
    <li><a href="users/">Users</a></li>
    <li><a href="management/">Koreksi</a></li>
    <li><a href="harian/">Buat Tantangan</a></li>
    <li><a href="Riwayat/">Riwayat Tantangan</a></li>
  </ul>
</div>
</aside>

<div id="overlay" class="lg:hidden"></div>

<div class="flex-1 min-h-screen flex flex-col lg:ml-64">
<header class="bg-white shadow-md p-4 flex items-center justify-between sticky top-0 z-10">
<div class="flex items-center gap-3">
  <button id="sidebar-toggle" class="text-blue-600 hover:text-blue-500 focus:outline-none lg:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
    </svg>
  </button>
  <h1 class="text-2xl font-bold text-blue-600">Dashboard Belajar Ngaji</h1>
</div>
</header>

<main class="p-6 flex-1 overflow-y-auto">

<!-- KPI Cards -->
<section class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8">
  <div class="kpi-card rounded-lg p-6">
    <h3 class="text-sm font-medium text-gray-500">Total Pengguna</h3>
    <div id="total-users-container" class="flex items-center mt-2"><div class="loader"></div></div>
    <p id="total-users" class="text-3xl font-bold text-blue-600 mt-2 hidden">0</p>
  </div>
  <div class="kpi-card rounded-lg p-6">
    <h3 class="text-sm font-medium text-gray-500">Kuis Hari Ini</h3>
    <div id="quiz-today-container" class="flex items-center mt-2"><div class="loader"></div></div>
    <p id="quiz-attempts-today" class="text-3xl font-bold text-blue-600 mt-2 hidden">0</p>
  </div>
</section>

<!-- Charts + Leaderboard -->
<section class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">

  <!-- Leaderboard -->
  <div class="lg:col-span-3 bg-white border border-gray-200 rounded-lg p-6 overflow-x-auto">
    <h3 class="font-semibold text-gray-700 mb-4">üèÜ Leaderboard - Top 10</h3>
    <table class="w-full text-sm text-left text-gray-600">
      <thead class="text-xs text-gray-500 uppercase bg-gray-100">
        <tr>
          <th class="py-3 px-6">Peringkat</th>
          <th class="py-3 px-6">Pengguna</th>
          <th class="py-3 px-6">Total Skor</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body">
        <tr><td colspan="3" class="text-center p-4"><div class="loader mx-auto"></div></td></tr>
      </tbody>
    </table>
  </div>

  <!-- Charts -->
  <div class="lg:col-span-2 bg-white border border-gray-200 rounded-lg p-4 flex items-center justify-center min-h-[250px]">
    <canvas id="popular-quizzes-chart"></canvas>
  </div>

  <div class="lg:col-span-3 bg-white border border-gray-200 rounded-lg p-4 flex flex-col justify-center min-h-[250px]">
    <h3 class="font-semibold text-gray-700 mb-4 text-center">Tren Skor</h3>
    <canvas id="lineChartScore"></canvas>
    <div class="mt-2 flex justify-center gap-4">
      <button id="btnDaily" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-500">Harian</button>
      <button id="btnWeekly" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Mingguan</button>
    </div>
  </div>

  <div class="lg:col-span-2 bg-white border border-gray-200 rounded-lg p-4 flex items-center justify-center min-h-[250px]">
    <canvas id="barChartAnswer"></canvas>
  </div>
    
  <div class="lg:col-span-2 bg-white border border-gray-200 rounded-lg p-4 flex items-center justify-center min-h-[250px]">
    <h3 class="font-semibold text-gray-700 mb-4">Benar vs Salah (Semua Kuis)</h3>
    <canvas id="pieChartTotal"></canvas>
  </div>

  <div class="lg:col-span-3 bg-white border border-gray-200 rounded-lg p-4 flex items-center justify-center min-h-[250px]">
    <h3 class="font-semibold text-gray-700 mb-4">Benar vs Salah (Tantangan Hari Ini)</h3>
    <canvas id="pieChartDaily"></canvas>
  </div>

</section>

<!-- Aktivitas Terbaru -->
<section>
<h3 class="text-xl font-semibold text-gray-700 mb-4">Aktivitas Terbaru</h3>
<div class="bg-white border border-gray-200 rounded-lg overflow-x-auto overflow-y-auto max-h-[400px]">
<table class="w-full text-sm text-left text-gray-600 min-w-[600px]">
<thead class="text-xs text-gray-500 uppercase bg-gray-100">
<tr>
<th class="py-3 px-6">Pengguna</th>
<th class="py-3 px-6">Nama Kuis/Tantangan</th>
<th class="py-3 px-6">Skor</th>
<th class="py-3 px-6">Waktu</th>
</tr>
</thead>
<tbody id="recent-activity-body">
    <tr><td colspan="4" class="text-center p-4"><div class="loader mx-auto"></div></td></tr>
</tbody>
</table>
</div>
</section>

</main>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// --- KONEKSI SUPABASE ---
const SUPABASE_URL = "https://jpxtbdawajjyrvqrgijd.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpweHRiZGF3YWpqeXJ2cXJnaWpkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjMxMjg5OCwiZXhwIjoyMDcxODg4ODk4fQ.1-CFqhW0mXPyv8jFyd-sa4m2FoCkyY4LbgiKGIKwb6I";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// --- UTILITIES ---
function formatQuizName(id) { 
  if (!id) return 'N/A';
  return id.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase()); 
}

function createChart(ctx, type, labels, data, colors, chartLabel) {
  // Hancurkan chart lama jika ada untuk mencegah duplikasi
  if (ctx.chart) {
      ctx.chart.destroy();
  }
  ctx.chart = new Chart(ctx, {
    type,
    data: {
      labels,
      datasets: [{
        label: chartLabel,
        data,
        backgroundColor: colors,
        fill: type === 'line' ? false : true,
        borderColor: type === 'line' ? colors[0] : colors,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' },
        title: { display: !!chartLabel, text: chartLabel }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
  return ctx.chart;
}

// --- FUNGSI TAMPILKAN PESAN ERROR ---
function displayError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        if(element.tagName === 'TBODY'){
            const colSpan = element.previousElementSibling.rows[0].cells.length || 1;
            element.innerHTML = `<tr><td colspan="${colSpan}" class="text-center p-4 text-red-500">${message}</td></tr>`;
        } else {
            element.innerHTML = `<div class="text-red-500">${message}</div>`;
        }
    }
}


// --- SIDEBAR TOGGLE ---
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
document.getElementById('sidebar-toggle').addEventListener('click', () => {
  sidebar.classList.toggle('-translate-x-full');
  overlay.style.display = sidebar.classList.contains('-translate-x-full') ? 'none' : 'block';
});
overlay.addEventListener('click', () => {
  sidebar.classList.add('-translate-x-full');
  overlay.style.display = 'none';
});

// --- MAIN SCRIPT ---
document.addEventListener('DOMContentLoaded', async () => {
  console.log("Memulai script dashboard...");

  // 1. CEK AUTENTIKASI PENGGUNA
  const { data: { user }, error: userError } = await supabase.auth.getUser();
  if (userError || !user) {
    console.error("Error autentikasi atau tidak ada user:", userError?.message);
    // Redirect ke halaman login jika tidak ada sesi pengguna yang aktif
    window.location.href = '/admin-login/'; 
    return;
  }
  console.log("User ditemukan:", user.email);

  // 2. CEK ROLE PENGGUNA
  const { data: profile, error: profileError } = await supabase
    .from('profiles')
    .select('role, username')
    .eq('id', user.id)
    .single();

  if (profileError || !profile || !['admin', 'superadmin'].includes(profile.role)) {
    console.error("Error mengambil profile atau role tidak valid:", profileError?.message);
    alert('Akses ditolak. Anda bukan admin.');
    window.location.href = '/';
    return;
  }
  const isSuperAdmin = profile.role === 'superadmin';
  console.log(`Role pengguna: ${profile.role}`);

  // 3. AMBIL SEMUA DATA YANG DIPERLUKAN DENGAN PENANGANAN ERROR
  const { data: quizAttempts, error: quizError } = await supabase.from('quiz_attempts').select('*');
  const { data: dashboardAttempts, error: dashboardError } = await supabase.from('dashboard_quiz_attempts').select('*');

  if(quizError) {
      console.error("Error mengambil quiz_attempts:", quizError.message);
      displayError('recent-activity-body', 'Gagal memuat data kuis.');
      return; // Hentikan eksekusi jika data utama gagal
  }
   if(dashboardError) {
      console.error("Error mengambil dashboard_quiz_attempts:", dashboardError.message);
      displayError('recent-activity-body', 'Gagal memuat data tantangan.');
      return; // Hentikan eksekusi jika data utama gagal
  }

  console.log(`Ditemukan ${quizAttempts.length} record kuis dan ${dashboardAttempts.length} record tantangan.`);

  // 4. FILTER DATA BERDASARKAN ROLE
  let quizAttemptsFiltered = isSuperAdmin ? quizAttempts : quizAttempts.filter(a => a.admin_id === user.id);
  let dashboardAttemptsFiltered = isSuperAdmin ? dashboardAttempts : dashboardAttempts.filter(a => a.admin_id === user.id);

  // --- RENDER DATA KE UI ---

  // KPI: Total Pengguna
  const { count, error: countError } = await supabase.from('profiles').select('*', { count: 'exact', head: true });
  document.getElementById('total-users-container').style.display = 'none';
  const totalUsersEl = document.getElementById('total-users');
  totalUsersEl.textContent = countError ? 'Error' : count || 0;
  totalUsersEl.classList.remove('hidden');

  // KPI: Kuis Hari Ini
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const quizToday = quizAttemptsFiltered.filter(a => new Date(a.submitted_at) >= today).length;
  document.getElementById('quiz-today-container').style.display = 'none';
  const quizAttemptsTodayEl = document.getElementById('quiz-attempts-today');
  quizAttemptsTodayEl.textContent = quizToday;
  quizAttemptsTodayEl.classList.remove('hidden');

  // LEADERBOARD
  const { data: leaderboardData, error: leaderboardError } = await supabase.from('leaderboard')
    .select('rank, username, total_score')
    .order('total_score', { ascending: false })
    .limit(10);
    
  const lbBody = document.getElementById('leaderboard-body');
  if (leaderboardError) {
      displayError('leaderboard-body', 'Gagal memuat leaderboard.');
  } else {
      lbBody.innerHTML = leaderboardData.length > 0 ? leaderboardData.map(u => `
        <tr class="border-b border-gray-200 hover:bg-gray-50">
          <td class="py-3 px-6 font-medium">${u.rank || '-'}</td>
          <td class="py-3 px-6">${u.username}</td>
          <td class="py-3 px-6 font-bold text-yellow-500">${u.total_score || 0}</td>
        </tr>
      `).join('') : `<tr><td colspan="3" class="py-4 px-6 text-center text-gray-400">Belum ada data skor.</td></tr>`;
  }
  
  // AKTIVITAS TERBARU
  const recentTbody = document.getElementById('recent-activity-body');
  const recentActivities = [...quizAttemptsFiltered, ...dashboardAttemptsFiltered].sort((a,b) => new Date(b.submitted_at) - new Date(a.submitted_at));
  recentTbody.innerHTML = recentActivities.length > 0 ? recentActivities.map(a => `
    <tr class="${a.is_correct === false ? 'wrong' : 'correct'} border-b border-gray-200 hover:bg-gray-50">
      <td class="py-4 px-6">${a.username || 'Tanpa Nama'}</td>
      <td class="py-4 px-6">${formatQuizName(a.quiz_id || a.quiz_question_id)}</td>
      <td class="py-4 px-6 font-medium">${a.score !== null ? a.score : (a.is_correct ? 1 : 0)}</td>
      <td class="py-4 px-6 text-sm text-gray-500">${new Date(a.submitted_at).toLocaleString('id-ID')}</td>
    </tr>
  `).join('') : `<tr><td colspan="4" class="py-4 px-6 text-center text-gray-400">Belum ada aktivitas.</td></tr>`;
  
  // CHART: KUIS TERPOPULER
  const popularCounts = {};
  quizAttemptsFiltered.forEach(a => { const name = formatQuizName(a.quiz_id); popularCounts[name] = (popularCounts[name] || 0) + 1; });
  const sortedQuizzes = Object.entries(popularCounts).sort(([,a],[,b]) => b - a).slice(0, 5);
  if(sortedQuizzes.length > 0) {
      createChart(document.getElementById('popular-quizzes-chart'), 'doughnut',
        sortedQuizzes.map(x => x[0]),
        sortedQuizzes.map(x => x[1]),
        ['#3b82f6','#60a5fa','#93c5fd','#bfdbfe','#e0f2fe'], 'Pengerjaan Kuis Terpopuler'
      );
  }

  // CHART: TREND SKOR
  const dayMap = {}, weekMap = {};
  quizAttemptsFiltered.forEach(a => {
    const d = new Date(a.submitted_at);
    const score = a.score || 0;
    const dayKey = d.toISOString().split('T')[0];
    if(!dayMap[dayKey]) dayMap[dayKey] = [];
    dayMap[dayKey].push(score);

    const year = d.getFullYear();
    const week = Math.ceil((((d - new Date(year, 0, 1)) / 86400000) + 1) / 7);
    const weekKey = `${year}-W${String(week).padStart(2, '0')}`;
    if(!weekMap[weekKey]) weekMap[weekKey] = [];
    weekMap[weekKey].push(score);
  });

  const dayLabels = Object.keys(dayMap).sort();
  const dayAvg = dayLabels.map(d => dayMap[d].reduce((s,v) => s + v, 0) / dayMap[d].length);
  const weekLabels = Object.keys(weekMap).sort();
  const weekAvg = weekLabels.map(w => weekMap[w].reduce((s,v) => s + v, 0) / weekMap[w].length);
  
  const ctxScore = document.getElementById('lineChartScore');
  let chartScore = null;
  if(dayLabels.length > 0) {
     chartScore = createChart(ctxScore, 'line', dayLabels, dayAvg, ['#3b82f6'], 'Rata-rata Skor Harian');
  }

  const updateChartButtons = (active) => {
    const dailyBtn = document.getElementById('btnDaily');
    const weeklyBtn = document.getElementById('btnWeekly');
    dailyBtn.className = 'px-3 py-1 rounded';
    weeklyBtn.className = 'px-3 py-1 rounded';
    if(active === 'daily'){
        dailyBtn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-500');
        weeklyBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
    } else {
        weeklyBtn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-500');
        dailyBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
    }
  }

  document.getElementById('btnDaily').addEventListener('click', () => {
    if(chartScore) {
        chartScore.data.labels = dayLabels;
        chartScore.data.datasets[0].data = dayAvg;
        chartScore.data.datasets[0].label = 'Rata-rata Skor Harian';
        chartScore.update();
        updateChartButtons('daily');
    }
  });

  document.getElementById('btnWeekly').addEventListener('click', () => {
     if(chartScore) {
        chartScore.data.labels = weekLabels;
        chartScore.data.datasets[0].data = weekAvg;
        chartScore.data.datasets[0].label = 'Rata-rata Skor Mingguan';
        chartScore.update();
        updateChartButtons('weekly');
    }
  });
  
  // CHART: PERSENTASE JAWABAN BENAR PER KUIS
  const quizAnswerMap = {};
  quizAttemptsFiltered.forEach(a => {
    const name = formatQuizName(a.quiz_id);
    if (!quizAnswerMap[name]) quizAnswerMap[name] = { correct: 0, total: 0 };
    quizAnswerMap[name].correct += (Number(a.score) || 0);
    quizAnswerMap[name].total += (Number(a.total_questions) || 0);
  });
  const quizLabels = Object.keys(quizAnswerMap);
  const quizPercentages = quizLabels.map(label => {
      const {correct, total} = quizAnswerMap[label];
      return total > 0 ? Math.round((correct / total) * 100) : 0;
  });
  if(quizLabels.length > 0){
      createChart(document.getElementById('barChartAnswer'), 'bar', quizLabels, quizPercentages,
      ['#3b82f6','#60a5fa','#93c5fd','#2563eb','#1e40af'], 'Persentase Jawaban Benar (%)'
      );
  }

  // CHART: BENAR VS SALAH (SEMUA KUIS)
  const totalCorrect = quizAttemptsFiltered.reduce((sum, a) => sum + (Number(a.score) || 0), 0);
  const totalQuestions = quizAttemptsFiltered.reduce((sum, a) => sum + (Number(a.total_questions) || 0), 0);
  if(totalQuestions > 0){
      createChart(document.getElementById('pieChartTotal'), 'pie', ['Benar', 'Salah'],
        [totalCorrect, totalQuestions - totalCorrect], ['#4CAF50', '#F44336'], 'Benar vs Salah (Semua Kuis)'
      );
  }

  // CHART: BENAR VS SALAH (TANTANGAN HARI INI)
  const todayDashboardAttempts = dashboardAttemptsFiltered.filter(a => new Date(a.submitted_at) >= today);
  const correctDashboardToday = todayDashboardAttempts.filter(a => a.is_correct).length;
  const totalDashboardToday = todayDashboardAttempts.length;
   if(totalDashboardToday > 0){
      createChart(document.getElementById('pieChartDaily'), 'pie', ['Benar', 'Salah'],
        [correctDashboardToday, totalDashboardToday - correctDashboardToday], ['#4CAF50', '#F44336'], 'Benar vs Salah (Tantangan Hari Ini)'
      );
  }

});
</script>

</body>
</html>