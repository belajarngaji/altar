<!DOCTYPE html>
<html lang="id" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Kuis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      background-color: #1f2937;
      color: white;
    }
    .kpi-card {
      background: #2d3748;
      border: 1px solid #4a5568;
    }
  </style>
</head>
<body class="antialiased">
  <header class="bg-gray-800 shadow-md p-4 sticky top-0 z-10">
    <div class="max-w-7xl mx-auto">
      <h1 class="text-2xl font-bold text-white">Dashboard Admin Kuis</h1>
    </div>
  </header>

  <main class="p-4 sm:p-6 md:p-8 max-w-7xl mx-auto">
    <div id="loading-state" class="text-center py-20">Memuat...</div>
    <div id="error-state" class="hidden text-red-400">Terjadi kesalahan.</div>
    <div id="main-content" class="hidden">
      
      <section class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8">
        <div class="kpi-card rounded-lg p-6">
          <h3 class="text-sm font-medium text-gray-400">Total Pengguna</h3>
          <p id="total-users" class="text-3xl font-bold text-white mt-2">0</p>
        </div>
        <div class="kpi-card rounded-lg p-6">
          <h3 class="text-sm font-medium text-gray-400">Kuis Hari Ini</h3>
          <p id="quiz-attempts-today" class="text-3xl font-bold text-white mt-2">0</p>
        </div>
      </section>

      <section class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
        <div class="lg:col-span-3 bg-gray-800 border border-gray-700 rounded-lg p-6">
          <h3 class="font-semibold text-white mb-4">üèÜ Leaderboard - Top 10</h3>
          <table class="w-full text-sm text-left text-gray-300">
            <thead class="text-xs text-gray-400 uppercase bg-gray-700/50">
              <tr>
                <th class="py-3 px-6">Peringkat</th>
                <th class="py-3 px-6">Pengguna</th>
                <th class="py-3 px-6">Total Skor</th>
              </tr>
            </thead>
            <tbody id="leaderboard-body"></tbody>
          </table>
        </div>
        <div class="lg:col-span-2 bg-gray-800 border border-gray-700 rounded-lg p-6 h-96">
          <h3 class="font-semibold text-white mb-4">Kuis Terpopuler</h3>
          <canvas id="popular-quizzes-chart"></canvas>
        </div>
      </section>

      <section>
        <h3 class="text-xl font-semibold text-white mb-4">Aktivitas Terbaru</h3>
        <table class="w-full text-sm text-left text-gray-300 bg-gray-800 border border-gray-700 rounded-lg">
          <thead class="text-xs text-gray-400 uppercase bg-gray-700/50">
            <tr>
              <th class="py-3 px-6">Pengguna</th>
              <th class="py-3 px-6">Nama Kuis</th>
              <th class="py-3 px-6">Skor</th>
              <th class="py-3 px-6">Waktu</th>
            </tr>
          </thead>
          <tbody id="recent-activity-body"></tbody>
        </table>
      </section>
    </div>
  </main>

<script>
  const supabaseUrl = "https://jpxtbdawajjyrvqrgijd.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpweHRiZGF3YWpqeXJ2cXJnaWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTI4OTgsImV4cCI6MjA3MTg4ODg5OH0.vEqCzHYBByFZEXeLIBqx6b40x6-tjSYa3Il_b2mI9NE";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  document.addEventListener("DOMContentLoaded", async () => {
    const loadingState = document.getElementById("loading-state");
    const errorState = document.getElementById("error-state");
    const mainContent = document.getElementById("main-content");

    try {
      // Total Pengguna
      const { data: users } = await supabase.from("profiles").select("*");
      document.getElementById("total-users").textContent = users.length;

      // Kuis Hari Ini
      const today = new Date().toISOString().split("T")[0];
      const { data: attempts } = await supabase.from("quiz_attempts").select("*").gte("created_at", today);
      document.getElementById("quiz-attempts-today").textContent = attempts.length;

      // Leaderboard
      const { data: leaderboard } = await supabase.from("quiz_attempts").select("user_id, score").order("score", { ascending: false }).limit(10);
      const lbBody = document.getElementById("leaderboard-body");
      leaderboard.forEach((row, index) => {
        lbBody.innerHTML += `<tr><td class="py-2 px-6">${index+1}</td><td class="py-2 px-6">${row.user_id}</td><td class="py-2 px-6">${row.score}</td></tr>`;
      });

      // Chart
      const { data: popular } = await supabase.from("quiz_attempts").select("quiz_name");
      const quizCounts = {};
      popular.forEach(q => quizCounts[q.quiz_name] = (quizCounts[q.quiz_name] || 0) + 1);
      new Chart(document.getElementById("popular-quizzes-chart").getContext("2d"), {
        type: "bar",
        data: {
          labels: Object.keys(quizCounts),
          datasets: [{ data: Object.values(quizCounts), backgroundColor: "rgba(75,192,192,0.7)" }]
        },
        options: { plugins: { legend: { display: false } } }
      });

      // Recent
      const { data: recent } = await supabase.from("quiz_attempts").select("user_id, quiz_name, score, created_at").order("created_at", { ascending: false }).limit(10);
      const recentBody = document.getElementById("recent-activity-body");
      recent.forEach(r => {
        recentBody.innerHTML += `<tr>
          <td class="py-2 px-6">${r.user_id}</td>
          <td class="py-2 px-6">${r.quiz_name}</td>
          <td class="py-2 px-6">${r.score}</td>
          <td class="py-2 px-6">${new Date(r.created_at).toLocaleString("id-ID")}</td>
        </tr>`;
      });

      loadingState.classList.add("hidden");
      mainContent.classList.remove("hidden");
    } catch (err) {
      console.error(err);
      loadingState.classList.add("hidden");
      errorState.classList.remove("hidden");
    }
  });
</script>
</body>
</html>