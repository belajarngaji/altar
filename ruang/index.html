<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Belajar Ngaji</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
@import url('https://rsms.me/inter/inter.css');
body { font-family: 'Inter', sans-serif; background-color: #f0f8ff; color: #1f2937; margin:0; overflow-x:hidden; }
.kpi-card { background:white; border:1px solid #e2e8f0; border-radius:.5rem; transition: transform .2s, box-shadow .2s;}
.kpi-card:hover { transform: translateY(-3px); box-shadow:0 6px 10px rgba(0,0,0,.1);}
.sidebar { background:white; border-right:1px solid #e2e8f0;}
.sidebar a { display:block; color:#1e3a8a; transition: all .2s; padding:.5rem 0; }
.sidebar a:hover { color:#2563eb; font-weight:600; }
.correct { background-color:#d1fae5;}
.wrong { background-color:#fee2e2;}
table { border-collapse:collapse; width:100%; min-width:600px;}
*, *::before, *::after { box-sizing:border-box; max-width:100%; }
header { position:sticky; top:0; z-index:10; }
#overlay { position:fixed; inset:0; background:rgba(0,0,0,.3); z-index:20; display:none;}
.loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body class="antialiased flex">

<aside id="sidebar" class="sidebar fixed top-0 left-0 h-full w-64 bg-white shadow-lg transform -translate-x-full lg:translate-x-0 transition-transform duration-300 z-30">
<div class="p-6">
  <h2 class="text-xl font-bold mb-6 text-blue-600">Menu Admin</h2>
  <ul class="space-y-4">
    <li><a href="#">Dashboard</a></li>
    <li><a href="users/">Users</a></li>
    <li><a href="management/">Koreksi</a></li>
    <li><a href="harian/">Buat Tantangan</a></li>
    <li><a href="Riwayat/">Riwayat Tantangan</a></li>
  </ul>
</div>
</aside>

<div id="overlay" class="lg:hidden"></div>

<div class="flex-1 min-h-screen flex flex-col lg:ml-64">
<header class="bg-white shadow-md p-4 flex items-center justify-between sticky top-0 z-10">
<div class="flex items-center gap-3">
  <button id="sidebar-toggle" class="text-blue-600 hover:text-blue-500 focus:outline-none lg:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
  </button>
  <h1 class="text-2xl font-bold text-blue-600">Dashboard Belajar Ngaji</h1>
</div>
</header>

<main class="p-6 flex-1 overflow-y-auto">
  <div id="loader-container" class="text-center py-10"><div class="loader"></div><p class="text-gray-500">Memuat data...</p></div>
  <div id="error-container" style="display: none; text-align: center; padding: 20px; background-color: #fff3f3; border: 1px solid #ffcccc; border-radius: 8px; margin: 20px;">
    <p id="error-message" style="color: #d9534f; margin: 0 0 15px 0;">Terjadi kesalahan.</p>
    <button id="retry-button" style="padding: 10px 20px; border: none; background-color: #007bff; color: white; border-radius: 5px; cursor: pointer;">Coba Lagi</button>
  </div>

  <div id="dashboard-content" style="display: none;">
    <section class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8">
      <div class="kpi-card p-6"><h3 class="text-sm font-medium text-gray-500">Total Pengguna</h3><p id="total-users" class="text-3xl font-bold text-blue-600 mt-2">0</p></div>
      <div class="kpi-card p-6"><h3 class="text-sm font-medium text-gray-500">Kuis Hari Ini</h3><p id="quiz-attempts-today" class="text-3xl font-bold text-blue-600 mt-2">0</p></div>
    </section>
    
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <div class="lg:col-span-3 bg-white border p-6 overflow-x-auto"><h3 class="font-semibold text-gray-700 mb-4">üèÜ Leaderboard - Top 10</h3><table class="w-full text-sm text-left"><thead class="text-xs uppercase bg-gray-100"><tr><th class="py-3 px-6">Peringkat</th><th class="py-3 px-6">Pengguna</th><th class="py-3 px-6">Total Skor</th></tr></thead><tbody id="leaderboard-body"></tbody></table></div>
      <div class="lg:col-span-1 bg-white border p-4"><h3 class="font-semibold text-gray-700 mb-4">Kuis Terpopuler</h3><canvas id="popular-quizzes-chart"></canvas></div>
      
      <div id="superadmin-only-charts" class="lg:col-span-2 contents"> 
        <div class="bg-white border p-4"><h3 class="font-semibold text-gray-700 mb-4">Benar vs Salah (Keseluruhan)</h3><canvas id="pieChartTotal"></canvas></div>
      </div>
    </section>

    <section id="superadmin-section" class="mb-8" style="display: none;">
      <div class="bg-white border p-6"><h3 class="font-semibold text-gray-700 mb-4">üìà Pertumbuhan Pengguna (Superadmin)</h3><canvas id="userGrowthChart"></canvas></div>
    </section>
    
    <section>
    <h3 class="text-xl font-semibold text-gray-700 mb-4">Aktivitas Terbaru</h3>
    <div class="bg-white border rounded-lg overflow-x-auto overflow-y-auto max-h-[400px]">
    <table class="w-full text-sm text-left"><thead class="text-xs uppercase bg-gray-100"><tr><th class="py-3 px-6">Pengguna</th><th class="py-3 px-6">Nama Kuis</th><th class="py-3 px-6">Skor</th><th class="py-3 px-6">Waktu</th></tr></thead><tbody id="recent-activity-body"></tbody></table>
    </div>
    </section>
  </div>
</main>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = "https://jpxtbdawajjyrvqrgijd.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpweHRiZGF3YWpqeXJ2cXJnaWpkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjMxMjg5OCwiZXhwIjoyMDcxODg4ODk4fQ.1-CFqhW0mXPyv8jFyd-sa4m2FoCkyY4LbgiKGIKwb6I";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const loaderContainer = document.getElementById('loader-container');
const errorContainer = document.getElementById('error-container');
const errorMessage = document.getElementById('error-message');
const retryButton = document.getElementById('retry-button');
const dashboardContent = document.getElementById('dashboard-content');
const superadminCharts = document.getElementById('superadmin-only-charts');
const superadminSection = document.getElementById('superadmin-section');

function formatQuizName(id){ if (!id) return 'Kuis Tidak Dikenal'; return id.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()); }
let charts = {};
function createOrUpdateChart(id,type,labels,data,colors,label){
  const ctx = document.getElementById(id).getContext('2d');
  if (charts[id]) { charts[id].destroy(); }
  charts[id] = new Chart(ctx,{type,data:{labels,datasets:[{label,data,backgroundColor:colors,fill:type==='line'?!1:!0,borderColor:colors,tension:0.3}]},options:{responsive:!0,maintainAspectRatio:!0,plugins:{legend:{position:'bottom'},title:{display:!!label,text:label}},scales:{y:{beginAtZero:!0}}}});
}
const sidebar=document.getElementById('sidebar'),overlay=document.getElementById('overlay');
document.getElementById('sidebar-toggle').addEventListener('click',()=>{sidebar.classList.toggle('-translate-x-full'),overlay.style.display=sidebar.classList.contains('-translate-x-full')?'none':'block'});
overlay.addEventListener('click',()=>{sidebar.classList.add('-translate-x-full'),overlay.style.display='none'});

document.addEventListener('DOMContentLoaded', () => {
  supabase.auth.onAuthStateChange(async (event, session) => {
    if (session && session.user) {
      // ==============================================
      // BARU: Ambil profil pengguna untuk mendapatkan role
      // ==============================================
      const { data: profile, error } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', session.user.id)
        .single();
        
      if (error || !profile) {
        console.error("Gagal mengambil role pengguna:", error);
        errorMessage.textContent = "Gagal memverifikasi role Anda. Silakan login kembali.";
        errorContainer.style.display = 'block';
        loaderContainer.style.display = 'none';
        await supabase.auth.signOut(); // Logout jika gagal ambil role
        return;
      }
      
      loadDashboardData(session.user, profile);
    } else {
      window.location.href = '/admin-login/';
    }
  });

  retryButton.addEventListener('click', () => {
    window.location.reload(); // Cara termudah untuk coba lagi
  });
});

async function loadDashboardData(user, profile) {
  loaderContainer.style.display = 'block';
  dashboardContent.style.display = 'none';
  errorContainer.style.display = 'none';

  try {
    const [
      { data: quizAttemptsFiltered, error: quizError },
      { data: allProfiles, error: profilesError }, // BARU: Ambil semua profil untuk chart pertumbuhan
      { count: totalUsers, error: usersError },
      { data: leaderboardData, error: leaderboardError }
    ] = await Promise.all([
      supabase.from('quiz_attempts').select('score, total_questions'),
      supabase.from('profiles').select('created_at'),
      supabase.from('profiles').select('*', { count: 'exact', head: true }),
      supabase.from('leaderboard').select('username, total_score').order('total_score', { ascending: false }).limit(10)
    ]);

    const firstError = quizError || profilesError || usersError || leaderboardError;
    if (firstError) throw firstError;

    // --- RENDER DATA UMUM (untuk semua admin) ---
    document.getElementById('total-users').textContent = totalUsers || 0;
    const today = new Date(); today.setHours(0,0,0,0);
    const quizToday = (quizAttemptsFiltered || []).filter(a => new Date(a.submitted_at) >= today).length;
    document.getElementById('quiz-attempts-today').textContent = quizToday;
    const lb = document.getElementById('leaderboard-body');
    lb.innerHTML = leaderboardData.map((u, index) => `
      <tr class="border-b"><td class="py-3 px-6 text-center font-medium">${index + 1}</td><td class="py-3 px-6">${u.username}</td><td class="py-3 px-6 text-center font-bold text-yellow-500">${u.total_score || 0}</td></tr>
    `).join('') || `<tr><td colspan="3" class="py-4 px-6 text-center">Belum ada data.</td></tr>`;
    
    // --- RENDER GRAFIK BERDASARKAN ROLE ---
    const userRole = profile.role;

    // Grafik yang selalu tampil untuk semua admin
    const counts = {};
    (quizAttemptsFiltered || []).forEach(a => { const name = formatQuizName(a.quiz_id); counts[name] = (counts[name] || 0) + 1; });
    const sortedQuizzes = Object.entries(counts).sort(([,a],[,b]) => b-a).slice(0,5);
    createOrUpdateChart('popular-quizzes-chart','doughnut', sortedQuizzes.map(x=>x[0]), sortedQuizzes.map(x=>x[1]), ['#3b82f6','#60a5fa','#93c5fd','#bfdbfe','#e0f2fe'], 'Pengerjaan');

    // Tampilkan/sembunyikan elemen berdasarkan role
    if (userRole === 'superadmin') {
      superadminCharts.style.display = 'contents'; // 'contents' agar tidak merusak grid layout
      superadminSection.style.display = 'block';
      
      // Render grafik khusus superadmin
      const totalCorrect = (quizAttemptsFiltered || []).reduce((s,a) => s + (Number(a.score)||0),0);
      const totalQuestions = (quizAttemptsFiltered || []).reduce((s,a) => s + (Number(a.total_questions)||0),0);
      const totalPercent = totalQuestions ? Math.round(totalCorrect / totalQuestions * 100) : 0;
      createOrUpdateChart('pieChartTotal', 'pie', ['Benar','Salah'], [totalPercent, 100-totalPercent], ['#4CAF50','#F44336'], 'Benar vs Salah (%)');

      // BARU: Chart Pertumbuhan Pengguna
      const userGrowth = (allProfiles || []).reduce((acc, p) => {
        const date = new Date(p.created_at).toISOString().split('T')[0];
        acc[date] = (acc[date] || 0) + 1;
        return acc;
      }, {});
      const sortedDates = Object.keys(userGrowth).sort();
      const cumulativeUsers = [];
      let total = 0;
      sortedDates.forEach(date => {
        total += userGrowth[date];
        cumulativeUsers.push(total);
      });
      createOrUpdateChart('userGrowthChart', 'line', sortedDates, cumulativeUsers, ['#1e40af'], 'Total Pengguna');

    } else { // Jika role adalah 'admin' atau lainnya
      superadminCharts.style.display = 'none';
      superadminSection.style.display = 'none';
    }

    loaderContainer.style.display = 'none';
    dashboardContent.style.display = 'block';

  } catch (error) {
    console.error("Gagal memuat data dashboard:", error);
    errorMessage.textContent = `Gagal memuat data: ${error.message}. Silakan coba lagi.`;
    errorContainer.style.display = 'block';
    loaderContainer.style.display = 'none';
  }
}
</script>

</body>
</html>