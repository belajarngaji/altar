<!DOCTYPE html>
<html lang="id" class="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Kuis — Kelola Batch & Soal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://rsms.me/inter/inter.css');
    :root{
      --brand:#2563eb; --brand-50:#eff6ff; --ink:#0f172a; --muted:#64748b; --line:#e6eef8;
      --card-shadow:0 10px 30px rgba(15,23,42,0.06);
    }
    html,body{height:100%}
    body{
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
      background: linear-gradient(180deg,#f8fbff,#f0f7ff); color:var(--ink); margin:0;
    }
    header{position:sticky;top:0;z-index:40;backdrop-filter:saturate(180%) blur(6px)}
    .card{background:white;border:1px solid var(--line);border-radius:12px;box-shadow:var(--card-shadow)}
    .btn{display:inline-flex;gap:.5rem;align-items:center;border-radius:10px;padding:.55rem .9rem;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-soft{background:#f1f5ff;color:#1e40af;border:1px solid #dbeafe}
    .btn-ghost{background:white;border:1px solid var(--line);color:#0b2a6b}
    .input,.select,textarea{width:100%;border:1px solid #e5edf6;background:white;border-radius:10px;padding:.6rem .75rem;outline:none}
    .input:focus,.select:focus,textarea:focus{border-color:#bdd3ff;box-shadow:0 0 0 6px #e8f0ff}
    .table-wrap{overflow-x:auto;max-height:56vh;overflow-y:auto;-webkit-overflow-scrolling:touch}
    .badge{font-size:.73rem;background:var(--brand-50);color:var(--brand);padding:.25rem .5rem;border-radius:.6rem;border:1px solid #dbeafe}
    .toast{position:fixed;right:1rem;bottom:1rem;background:white;border:1px solid var(--line);padding:.8rem 1rem;border-radius:12px;box-shadow:var(--card-shadow);display:none;z-index:60}
    @media (max-width:640px){.table-wrap{max-height:50vh}}
  </style>
</head>
<body>

<header class="bg-white/80 border-b border-[var(--line)]">
  <div class="max-w-5xl mx-auto flex items-center justify-between gap-3 px-4 sm:px-6 py-3">
    <div class="flex items-center gap-3">
      <button id="btn-back" class="btn btn-soft">← Kembali</button>
      <h1 class="text-lg sm:text-xl font-bold text-slate-800">Admin — Kelola Batch & Soal</h1>
    </div>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 sm:px-6 py-6 pb-28 sm:pb-24">

  <!-- Batch info cards -->
  <section class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
    <div class="card p-4">
      <div class="text-xs text-slate-500">Batch Aktif</div>
      <div class="mt-1 flex items-center gap-2">
        <span id="activeBatch" class="text-sm font-semibold text-slate-800">— belum dimuat —</span>
        <span id="batchSavedBadge" class="badge" style="display:none">Tersimpan</span>
      </div>
      <div class="text-xs text-slate-400 mt-1">Generate atau pilih riwayat batch, lalu klik Muat.</div>
    </div>
    <div class="card p-4">
      <div class="text-xs text-slate-500">Jumlah Soal</div>
      <div id="countBatch" class="text-xl font-semibold text-slate-800 mt-1">0</div>
      <div class="text-xs text-slate-400 mt-1">Dalam batch yang sedang dimuat.</div>
    </div>
    <div class="card p-4">
      <div class="text-xs text-slate-500">Petunjuk</div>
      <div class="text-sm text-slate-800">Satu batch = beberapa soal. Batch dicatat ke database sehingga tidak hilang saat refresh.</div>
    </div>
  </section>

  <!-- Batch form -->
  <section class="card p-5 mb-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2">
        <label class="block text-sm font-medium text-slate-700 mb-1">Batch ID <span class="text-red-500">*</span></label>
        <div class="flex flex-col sm:flex-row gap-2">
          <input id="batchId" class="input flex-1" type="text" placeholder="contoh: batch_2025xxxx_xxxxxx_abcd" />
          <div class="flex gap-2">
            <button type="button" id="genBatch" class="btn btn-ghost">Generate</button>
            <button type="button" id="loadBatch" class="btn btn-primary">Muat</button>
          </div>
        </div>
        <p class="text-xs text-slate-500 mt-2">Klik Generate untuk membuat batch baru lalu Muat untuk mengaktifkannya.</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Riwayat Batch (20 terakhir)</label>
        <div class="flex gap-2">
          <select id="historySelect" class="select flex-1"></select>
          <button id="useHistory" class="btn btn-soft">Pakai</button>
        </div>
        <p class="text-xs text-slate-500 mt-2">Pilih batch lama dari database untuk dimuat.</p>
      </div>
    </div>
  </section>

  <!-- Soal form -->
  <section class="card p-5 mb-6">
    <form id="quizForm" class="space-y-4">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div class="sm:col-span-2">
          <label class="block text-sm font-medium text-slate-700 mb-1">Pertanyaan <span class="text-red-500">*</span></label>
          <textarea id="questionText" rows="3" class="input" placeholder="Tulis pertanyaan..." required></textarea>
        </div>
        <div class="sm:col-span-1">
          <label class="block text-sm font-medium text-slate-700 mb-1">Status Form</label>
          <div id="modeBadge" class="w-full border border-slate-200 rounded-md px-3 py-2 small bg-slate-50">Tambah Soal</div>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div><label class="block text-sm font-medium text-slate-700 mb-1">Opsi A</label><input id="optA" class="input" type="text" /></div>
        <div><label class="block text-sm font-medium text-slate-700 mb-1">Opsi B</label><input id="optB" class="input" type="text" /></div>
        <div><label class="block text-sm font-medium text-slate-700 mb-1">Opsi C</label><input id="optC" class="input" type="text" /></div>
        <div><label class="block text-sm font-medium text-slate-700 mb-1">Opsi D</label><input id="optD" class="input" type="text" /></div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Jawaban Benar</label>
          <select id="correctAns" class="select">
            <option value="">— pilih —</option>
            <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
          </select>
        </div>
        <div class="sm:col-span-2 flex gap-2 justify-end">
          <button id="resetForm" type="button" class="btn btn-ghost">Reset</button>
          <button id="submitBtn" type="submit" class="btn btn-primary">Simpan Soal</button>
        </div>
      </div>

      <div id="formMessage" class="text-sm text-slate-500 small"></div>
    </form>
  </section>

  <!-- Tabel soal -->
  <section class="card p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-sm font-semibold text-slate-800">Daftar Soal (Batch yang dimuat)</h2>
      <div class="text-xs text-slate-500">Klik baris untuk cepat Edit</div>
    </div>
    <div class="table-wrap border border-slate-100 rounded-md">
      <table class="min-w-[980px] w-full text-sm text-slate-700">
        <thead class="bg-slate-50 sticky top-0 z-10">
          <tr>
            <th class="text-xs text-slate-500 px-3 py-2">#</th>
            <th class="text-xs text-slate-500 px-3 py-2">Dibuat</th>
            <th class="text-xs text-slate-500 px-3 py-2">Pertanyaan</th>
            <th class="text-xs text-slate-500 px-3 py-2">A</th>
            <th class="text-xs text-slate-500 px-3 py-2">B</th>
            <th class="text-xs text-slate-500 px-3 py-2">C</th>
            <th class="text-xs text-slate-500 px-3 py-2">D</th>
            <th class="text-xs text-slate-500 px-3 py-2">Benar</th>
            <th class="text-xs text-slate-500 px-3 py-2 text-right">Aksi</th>
          </tr>
        </thead>
        <tbody id="questionsBody">
          <tr><td colspan="9" class="text-center text-slate-400 py-8">Muat batch untuk lihat soal.</td></tr>
        </tbody>
      </table>
    </div>
  </section>

</main>

<footer class="max-w-5xl mx-auto px-6 py-6 text-center text-xs text-slate-400">© 2025 — Dashboard</footer>
<div id="toast" class="toast"></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

const SUPABASE_URL = "https://jpxtbdawajjyrvqrgijd.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpweHRiZGF3YWpqeXJ2cXJnaWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTI4OTgsImV4cCI6MjA3MTg4ODg5OH0.vEqCzHYBByFZEXeLIBqx6b40x6-tjSYa3Il_b2mI9NE"; 
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

document.addEventListener('DOMContentLoaded', async ()=>{

  // =====================
  // CEK ROLE
  // =====================
  const { data: { user } } = await supabase.auth.getUser();
  if(!user){ window.location.href='/admin-login/'; return; }
  const { data: profile } = await supabase.from('profiles').select('role').eq('id',user.id).single();
  if(!profile || !['admin','superadmin'].includes(profile.role)){ alert('Anda tidak memiliki akses.'); window.location.href='/'; return; }

  // =====================
  // ELEMENT REFS
  // =====================
  const btnBack = document.getElementById('btn-back');
  const batchIdInput = document.getElementById('batchId');
  const genBatchBtn = document.getElementById('genBatch');
  const loadBatchBtn = document.getElementById('loadBatch');
  const activeBatch = document.getElementById('activeBatch');
  const batchSavedBadge = document.getElementById('batchSavedBadge');
  const historySelect = document.getElementById('historySelect');
  const useHistoryBtn = document.getElementById('useHistory');
  const quizForm = document.getElementById('quizForm');
  const questionText = document.getElementById('questionText');
  const optA = document.getElementById('optA');
  const optB = document.getElementById('optB');
  const optC = document.getElementById('optC');
  const optD = document.getElementById('optD');
  const correctAns = document.getElementById('correctAns');
  const submitBtn = document.getElementById('submitBtn');
  const resetFormBtn = document.getElementById('resetForm');
  const formMessage = document.getElementById('formMessage');
  const modeBadge = document.getElementById('modeBadge');
  const questionsBody = document.getElementById('questionsBody');
  const countBatch = document.getElementById('countBatch');
  const toast = document.getElementById('toast');

  let loadedBatch = null, editMode=false, editId=null;

  function showToast(msg){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1800); }
  function escapeHtml(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function resetForm(){
    editMode=false; editId=null;
    submitBtn.textContent='Simpan Soal';
    modeBadge.textContent='Tambah Soal';
    quizForm.reset();
    formMessage.textContent='';
  }

  function genBatchId(){
    const d = new Date();
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
    const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0'), ss=String(d.getSeconds()).padStart(2,'0');
    const r = Math.random().toString(36).slice(2,6);
    return `batch_${y}${m}${day}_${hh}${mm}_${r}`;
  }

  function setActiveBatchUI(code,saved){
    loadedBatch=code;
    activeBatch.textContent=code||'—';
    batchIdInput.value=code||'';
    if(code){
      localStorage.setItem('activeBatch',code);
      batchSavedBadge.style.display=saved?'inline-block':'none';
    } else batchSavedBadge.style.display='none';
  }

  async function ensureBatchExistsInDB(batchCode){
    if(!batchCode) return false;
    try{
      const { data,error } = await supabase.from('dashboard_quiz_batches').select('id').eq('batch_code',batchCode).limit(1);
      if(error) return false;
      if(data?.length>0) return true;
      const ins = await supabase.from('dashboard_quiz_batches').insert([{ batch_code:batchCode }]).select();
      return !ins.error;
    }catch(e){ console.warn(e); return false; }
  }

  async function loadHistoryOptions(){
    historySelect.innerHTML=`<option>Memuat...</option>`;
    try{
      const { data,error } = await supabase.from('dashboard_quiz_batches').select('batch_code').order('created_at',{ascending:false}).limit(20);
      if(error){ historySelect.innerHTML=`<option>Gagal memuat</option>`; return; }
      if(!data?.length){ historySelect.innerHTML=`<option>Belum ada batch</option>`; return; }
      historySelect.innerHTML = data.map(r=>`<option value="${escapeHtml(r.batch_code)}">${escapeHtml(r.batch_code)}</option>`).join('');
    }catch(e){ historySelect.innerHTML=`<option>Gagal memuat</option>`; }
  }

  btnBack.addEventListener('click', ()=>{ if(document.referrer) window.history.back(); else window.location.href='/'; });
  genBatchBtn.addEventListener('click', async ()=>{
    genBatchBtn.disabled=true;
    const newBatch = genBatchId();
    const { data,error } = await supabase.from('dashboard_quiz_batches').insert([{ batch_code:newBatch }]).select();
    if(error){ alert('Gagal buat batch'); genBatchBtn.disabled=false; return; }
    setActiveBatchUI(newBatch,true); await loadHistoryOptions(); showToast('Batch dibuat & diaktifkan.'); renderQuestions([]); countBatch.textContent='0';
    genBatchBtn.disabled=false;
  });

  loadBatchBtn.addEventListener('click', async ()=>{
    const batch=batchIdInput.value.trim(); if(!batch){ alert('Isi Batch ID terlebih dahulu.'); return; }
    const saved=await ensureBatchExistsInDB(batch); setActiveBatchUI(batch,!!saved);
    await fetchBatch(batch); await loadHistoryOptions(); showToast('Batch dimuat.');
  });

  useHistoryBtn?.addEventListener('click', async (e)=>{
    e.preventDefault();
    const sel = historySelect.value;
    if(!sel){ alert('Pilih batch dulu'); return; }
    batchIdInput.value = sel;
    const saved = await ensureBatchExistsInDB(sel);
    setActiveBatchUI(sel, !!saved);
    await fetchBatch(sel);
    showToast('Batch riwayat dimuat.');
  });

  async function fetchBatch(batch){
    if(!batch) return renderQuestions([]);
    try{
      const { data,error } = await supabase.from('dashboard_quiz').select('*').eq('batch_code',batch).order('created_at',{ascending:true});
      if(error){ console.warn(error); return renderQuestions([]); }
      renderQuestions(data || []);
    }catch(e){ console.warn(e); renderQuestions([]); }
  }

  function renderQuestions(rows){
    if(!rows || rows.length===0){
      questionsBody.innerHTML=`<tr><td colspan="9" class="text-center py-8 text-slate-400">Belum ada soal dalam batch ini.</td></tr>`;
      countBatch.textContent='0';
      return;
    }
    countBatch.textContent = rows.length;
    questionsBody.innerHTML = rows.map(r=>{
      const opts = r.options || {};
      const created = new Date(r.created_at||r.updated_at||Date.now()).toLocaleString('id-ID');
      return `
      <tr data-row-id="${r.id}" class="border-b hover:bg-slate-50/60 cursor-pointer">
        <td class="px-3 py-2 text-xs text-slate-500">${r.id}</td>
        <td class="px-3 py-2 text-xs text-slate-500">${created}</td>
        <td class="px-3 py-2">${escapeHtml(opts.question_text)}</td>
        <td class="px-3 py-2">${escapeHtml(opts.A)}</td>
        <td class="px-3 py-2">${escapeHtml(opts.B)}</td>
        <td class="px-3 py-2">${escapeHtml(opts.C)}</td>
        <td class="px-3 py-2">${escapeHtml(opts.D)}</td>
        <td class="px-3 py-2 font-semibold">${escapeHtml(opts.correct_answer)}</td>
        <td class="px-3 py-2 text-right flex gap-1 justify-end">
          <button class="btn btn-soft btn-edit" data-id="${r.id}">Edit</button>
          <button class="btn btn-ghost btn-delete" data-id="${r.id}">Hapus</button>
        </td>
      </tr>
      `;
    }).join('');

    // Attach Edit/Delete events
    document.querySelectorAll('.btn-edit').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id=b.dataset.id;
        const { data } = await supabase.from('dashboard_quiz').select('*').eq('id',id).single();
        if(!data) return showToast('Gagal ambil soal');
        editMode=true; editId=id;
        questionText.value = data.options?.question_text||'';
        optA.value = data.options?.A||'';
        optB.value = data.options?.B||'';
        optC.value = data.options?.C||'';
        optD.value = data.options?.D||'';
        correctAns.value = data.options?.correct_answer||'';
        submitBtn.textContent='Update Soal';
        modeBadge.textContent='Edit Soal';
        window.scrollTo({ top:0, behavior:'smooth' });
      });
    });

    document.querySelectorAll('.btn-delete').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id=b.dataset.id;
        if(!confirm('Hapus soal ini?')) return;
        const { error } = await supabase.from('dashboard_quiz').delete().eq('id',id);
        if(error){ showToast('Gagal hapus soal'); return; }
        showToast('Soal dihapus'); fetchBatch(loadedBatch);
      });
    });
  }

  resetFormBtn.addEventListener('click', ()=>{ resetForm(); });

  quizForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!loadedBatch){ alert('Muat batch terlebih dahulu'); return; }
    const question = questionText.value.trim();
    if(!question){ alert('Tulis pertanyaan'); return; }
    const newObj = {
      batch_code: loadedBatch,
      options: {
        question_text: question,
        A: optA.value.trim(),
        B: optB.value.trim(),
        C: optC.value.trim(),
        D: optD.value.trim(),
        correct_answer: correctAns.value
      }
    };
    submitBtn.disabled = true;
    try{
      if(editMode && editId){
        const { error } = await supabase.from('dashboard_quiz').update(newObj).eq('id',editId);
        if(error){ showToast('Gagal update soal'); submitBtn.disabled=false; return; }
        showToast('Soal diperbarui');
      } else {
        const { error } = await supabase.from('dashboard_quiz').insert([newObj]);
        if(error){ showToast('Gagal tambah soal'); submitBtn.disabled=false; return; }
        showToast('Soal ditambahkan');
      }
      resetForm(); await fetchBatch(loadedBatch);
    }catch(err){ console.warn(err); showToast('Terjadi kesalahan'); }
    submitBtn.disabled=false;
  });

  // Load last active batch
  const lastBatch = localStorage.getItem('activeBatch');
  if(lastBatch){ batchIdInput.value=lastBatch; await fetchBatch(lastBatch); setActiveBatchUI(lastBatch,true); }
  await loadHistoryOptions();

}); // DOMContentLoaded
</script>

</body>
</html>