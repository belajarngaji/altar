<!DOCTYPE html>
<html lang="id" class="bg-gray-50">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Kelola Soal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="min-h-screen flex flex-col p-6 text-gray-800">
  <div class="max-w-4xl mx-auto w-full bg-white shadow-lg rounded-xl p-6">
    <h1 class="text-2xl font-bold text-blue-600 mb-4">Dashboard Admin - Kelola Soal</h1>

    <!-- Batch Control -->
    <div class="flex flex-col sm:flex-row gap-2 mb-6">
      <input id="batchIdInput" type="text" placeholder="Batch ID"
        class="border p-2 rounded w-full sm:w-1/2" />
      <button id="genBatchBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Generate Batch</button>
      <button id="loadBatchBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Load Batch</button>
    </div>

    <p class="mb-4">Batch Aktif: <span id="activeBatch" class="font-semibold text-blue-500">-</span></p>

    <!-- Table Soal -->
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white border">
        <thead>
          <tr class="bg-gray-100">
            <th class="px-4 py-2 border">ID</th>
            <th class="px-4 py-2 border">Pertanyaan</th>
            <th class="px-4 py-2 border">Opsi</th>
            <th class="px-4 py-2 border">Jawaban</th>
            <th class="px-4 py-2 border">Batch</th>
          </tr>
        </thead>
        <tbody id="questionsBody">
          <tr><td colspan="5" class="text-center py-4 text-gray-400">Belum ada data</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
const supabaseUrl = "https://jpxtbdawajjyrvqrgijd.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpweHRiZGF3YWpqeXJ2cXJnaWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTI4OTgsImV4cCI6MjA3MTg4ODg5OH0.vEqCzHYBByFZEXeLIBqx6b40x6-tjSYa3Il_b2mI9NE";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

const batchIdInput = document.getElementById('batchIdInput');
const genBatchBtn = document.getElementById('genBatchBtn');
const loadBatchBtn = document.getElementById('loadBatchBtn');
const activeBatch = document.getElementById('activeBatch');
const questionsBody = document.getElementById('questionsBody');
let loadedBatch = null;

function genBatchId() {
  return 'BATCH-' + Math.random().toString(36).substring(2, 10).toUpperCase();
}

// Generate Batch
genBatchBtn.addEventListener('click', async () => {
  const batchCode = genBatchId();
  const { data, error } = await supabase
    .from('dashboard_quiz_batches')
    .insert([{ batch_code: batchCode }])
    .select();

  if (error) {
    console.error('Error insert batch:', error);
    alert('Gagal membuat batch!');
    return;
  }

  batchIdInput.value = batchCode;
  loadedBatch = batchCode;
  activeBatch.textContent = batchCode;
  localStorage.setItem('activeBatch', batchCode);
});

// Load Batch
loadBatchBtn.addEventListener('click', async () => {
  const batch = batchIdInput.value.trim();
  if (!batch) { alert('Isi Batch ID terlebih dahulu.'); return; }
  loadedBatch = batch;
  activeBatch.textContent = batch;
  localStorage.setItem('activeBatch', batch);
  await fetchBatch(batch);
});

// Fetch Batch Questions
async function fetchBatch(batch){
  questionsBody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-slate-400">Memuat...</td></tr>`;
  try {
    const { data, error } = await supabase
      .from('dashboard_quiz_questions')
      .select('id, question_text, options, correct_answer, batch_id')
      .eq('batch_id', batch)
      .order('created_at', { ascending: false });

    if (error) throw error;
    renderQuestions(data || []);
  } catch(err){
    console.error(err);
    questionsBody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-red-500">${err.message || 'Gagal memuat'}</td></tr>`;
    activeBatch.textContent = '— error —';
  }
}

// Render Questions
function renderQuestions(list){
  if (list.length === 0) {
    questionsBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-400">Tidak ada soal untuk batch ini</td></tr>`;
    return;
  }
  questionsBody.innerHTML = list.map(q => `
    <tr>
      <td class="border px-4 py-2">${q.id}</td>
      <td class="border px-4 py-2">${q.question_text}</td>
      <td class="border px-4 py-2">${JSON.stringify(q.options)}</td>
      <td class="border px-4 py-2">${q.correct_answer}</td>
      <td class="border px-4 py-2">${q.batch_id}</td>
    </tr>
  `).join('');
}

// Load Batch on Page Load
document.addEventListener('DOMContentLoaded', async () => {
  const savedBatch = localStorage.getItem('activeBatch');
  if (savedBatch) {
    batchIdInput.value = savedBatch;
    loadedBatch = savedBatch;
    activeBatch.textContent = savedBatch;
    await fetchBatch(savedBatch);
  } else {
    // Ambil batch terbaru dari database
    const { data, error } = await supabase
      .from('dashboard_quiz_batches')
      .select('batch_code')
      .order('created_at', { ascending: false })
      .limit(1);

    if (data && data.length > 0) {
      const latestBatch = data[0].batch_code;
      batchIdInput.value = latestBatch;
      loadedBatch = latestBatch;
      activeBatch.textContent = latestBatch;
      localStorage.setItem('activeBatch', latestBatch);
      await fetchBatch(latestBatch);
    }
  }
});
</script>
</body>
</html>