<!DOCTYPE html>
<html lang="id" class="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Kuis — Input per Batch</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://rsms.me/inter/inter.css');
    body { font-family: 'Inter', sans-serif; background: linear-gradient(180deg,#f8fbff,#f0f7ff); color:#0f172a; margin:0; }
    .card { background:white; border:1px solid #e6eef8; border-radius:12px; box-shadow:0 6px 18px rgba(14,42,80,0.04); }
    .small { font-size:.9rem; }
    header { position: sticky; top:0; z-index:40; }
    /* table scroll area */
    .table-wrap { overflow-x:auto; max-height:56vh; overflow-y:auto; -webkit-overflow-scrolling:touch; }
    /* mobile tweaks */
    @media (max-width:640px){
      .px-lg { padding-left:1rem; padding-right:1rem; }
      .px-form { padding-left:.6rem; padding-right:.6rem; }
    }
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <header class="bg-white shadow-sm">
    <div class="max-w-3xl mx-auto flex items-center justify-between gap-3 px-6 py-3">
      <div class="flex items-center gap-3">
        <button id="btn-back" class="text-blue-600 bg-blue-50 px-3 py-2 rounded-md hover:bg-blue-100">← Kembali</button>
        <h1 class="text-lg font-semibold text-slate-800">Buat soal</h1>
      </div>
      <div class="text-sm text-slate-500">Mode: <span class="font-medium text-slate-700">Soal Sekali Jawab</span></div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-3xl mx-auto px-6 py-6 pb-24">
    <!-- KPI -->
    <section class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
      <div class="card p-4 small">
        <div class="text-xs text-slate-400">Batch Aktif</div>
        <div id="activeBatch" class="text-sm font-semibold text-slate-800">— belum dimuat —</div>
        <div class="text-xs text-slate-400 mt-1">Masukkan atau generate batch lalu klik <em>Muat Batch</em>.</div>
      </div>
      <div class="card p-4 small">
        <div class="text-xs text-slate-400">Soal di Batch</div>
        <div id="countBatch" class="text-sm font-semibold text-slate-800">0</div>
        <div class="text-xs text-slate-400 mt-1">Jumlah soal yang sedang dimuat.</div>
      </div>
      <div class="card p-4 small">
        <div class="text-xs text-slate-400">Petunjuk</div>
        <div class="text-sm text-slate-800">Satu batch = satu periode kuis. Setelah semua user menjawab semua soal batch ini → tidak ada soal lagi sampai batch baru dibuat.</div>
      </div>
    </section>

    <!-- FORM -->
    <section class="card p-5 mb-6">
      <form id="quizForm" class="space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="sm:col-span-2">
            <label class="block text-sm font-medium text-slate-700 mb-1">Batch ID <span class="text-red-500">*</span></label>
            <div class="flex gap-2">
              <input id="batchId" type="text" required class="flex-1 border border-slate-200 rounded-md px-3 py-2 small" placeholder="contoh: batch_2025_09_01_120000_ab12" />
              <button type="button" id="genBatch" class="px-3 py-2 rounded-md bg-slate-100 hover:bg-slate-200 small">Generate</button>
              <button type="button" id="loadBatch" class="px-3 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-500 small">Muat</button>
            </div>
            <p class="text-xs text-slate-400 mt-1">Semua soal harus punya batch. Anda dapat menggunakan tombol Generate untuk membuat batch baru cepat.</p>
          </div>
          <div class="sm:col-span-1">
            <label class="block text-sm font-medium text-slate-700 mb-1">Mode</label>
            <div class="w-full border border-slate-200 rounded-md px-3 py-2 small">Tambah / Edit (form akan berubah saat Edit)</div>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Pertanyaan <span class="text-red-500">*</span></label>
          <textarea id="questionText" rows="3" class="w-full border border-slate-200 rounded-md px-3 py-2 small" placeholder="Tulis pertanyaan..." required></textarea>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Opsi A</label>
            <input id="optA" type="text" class="w-full border border-slate-200 rounded-md px-3 py-2 small" placeholder="Teks opsi A">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Opsi B</label>
            <input id="optB" type="text" class="w-full border border-slate-200 rounded-md px-3 py-2 small" placeholder="Teks opsi B">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Opsi C</label>
            <input id="optC" type="text" class="w-full border border-slate-200 rounded-md px-3 py-2 small" placeholder="Teks opsi C">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Opsi D</label>
            <input id="optD" type="text" class="w-full border border-slate-200 rounded-md px-3 py-2 small" placeholder="Teks opsi D">
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Jawaban Benar</label>
            <select id="correctAns" class="w-full border border-slate-200 rounded-md px-3 py-2 small">
              <option value="">— pilih —</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
          </div>
          <div class="sm:col-span-2 flex gap-2 justify-end">
            <button id="resetForm" type="button" class="px-4 py-2 rounded-md bg-slate-100 hover:bg-slate-200 small">Reset</button>
            <button id="submitBtn" type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-500 small">Simpan Soal</button>
          </div>
        </div>

        <div id="formMessage" class="text-sm text-slate-500 small"></div>
      </form>
    </section>

    <!-- TABLE -->
    <section class="card p-4">
      <h2 class="text-sm font-semibold text-slate-800 mb-3">Daftar Soal (Batch yang dimuat)</h2>
      <div class="table-wrap border border-slate-100 rounded-md p-2">
        <table class="min-w-[900px] w-full text-sm text-slate-700">
          <thead class="bg-slate-50 sticky top-0 z-10">
            <tr>
              <th class="text-xs text-slate-500 px-3 py-2">#</th>
              <th class="text-xs text-slate-500 px-3 py-2">Dibuat</th>
              <th class="text-xs text-slate-500 px-3 py-2">Pertanyaan</th>
              <th class="text-xs text-slate-500 px-3 py-2">A</th>
              <th class="text-xs text-slate-500 px-3 py-2">B</th>
              <th class="text-xs text-slate-500 px-3 py-2">C</th>
              <th class="text-xs text-slate-500 px-3 py-2">D</th>
              <th class="text-xs text-slate-500 px-3 py-2">Benar</th>
              <th class="text-xs text-slate-500 px-3 py-2 text-right">Aksi</th>
            </tr>
          </thead>
          <tbody id="questionsBody">
            <tr><td colspan="9" class="text-center text-slate-400 py-8">Muat batch untuk lihat soal.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <footer class="max-w-3xl mx-auto px-6 py-6 text-center text-xs text-slate-400">
    © 2025 — Dasboard 
  </footer>

  <!-- SCRIPT -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // ======= GANTI DENGAN KONFIG MU =======
    const SUPABASE_URL = "https://jpxtbdawajjyrvqrgijd.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpweHRiZGF3YWpqeXJ2cXJnaWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTI4OTgsImV4cCI6MjA3MTg4ODg5OH0.vEqCzHYBByFZEXeLIBqx6b40x6-tjSYa3Il_b2mI9NE"; // gunakan anon key / edge function key — jangan service_role pada frontend publik
    // =======================================

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // UI refs
    const btnBack = document.getElementById('btn-back');
    const batchIdInput = document.getElementById('batchId');
    const genBatchBtn = document.getElementById('genBatch');
    const loadBatchBtn = document.getElementById('loadBatch');
    const activeBatch = document.getElementById('activeBatch');
    const countBatch = document.getElementById('countBatch');

    const quizForm = document.getElementById('quizForm');
    const questionText = document.getElementById('questionText');
    const optA = document.getElementById('optA');
    const optB = document.getElementById('optB');
    const optC = document.getElementById('optC');
    const optD = document.getElementById('optD');
    const correctAns = document.getElementById('correctAns');
    const submitBtn = document.getElementById('submitBtn');
    const resetFormBtn = document.getElementById('resetForm');
    const formMessage = document.getElementById('formMessage');

    const questionsBody = document.getElementById('questionsBody');

    let loadedBatch = null;
    let editMode = false;
    let editId = null;

    // helpers
    function genBatchId(){
      const tz = 'Asia/Jakarta';
      const d = new Date(new Date().toLocaleString('en-US', { timeZone: tz }));
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      const ss = String(d.getSeconds()).padStart(2,'0');
      const r = Math.random().toString(36).slice(2,6);
      return `batch_${y}${m}${day}_${hh}${mm}${ss}_${r}`;
    }

    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function resetForm(){
      editMode = false;
      editId = null;
      submitBtn.textContent = 'Simpan Soal';
      quizForm.reset();
      formMessage.textContent = '';
    }

    // Navigation
    btnBack.addEventListener('click', () => {
      // kembali ke path sebelumnya
      if (document.referrer) window.history.back();
      else window.location.href = '/';
    });

    // Generate batch
    genBatchBtn.addEventListener('click', () => {
      batchIdInput.value = genBatchId();
    });

    // Load batch
    loadBatchBtn.addEventListener('click', async () => {
      const batch = batchIdInput.value.trim();
      if(!batch){ alert('Isi Batch ID terlebih dahulu (atau Generate).'); return; }
      loadedBatch = batch;
      activeBatch.textContent = batch;
      await fetchBatch(batch);
    });

    // fetch batch questions
    async function fetchBatch(batch){
      questionsBody.innerHTML = `<tr><td colspan="9" class="text-center py-8 text-slate-400">Memuat...</td></tr>`;
      try {
        const { data, error } = await supabase
          .from('dashboard_quiz_questions')
          .select('id, question_text, options, correct_answer, created_at, updated_at, batch_id')
          .eq('batch_id', batch)
          .order('created_at', { ascending: false });

        if (error) throw error;
        renderQuestions(data || []);
      } catch(err){
        console.error(err);
        questionsBody.innerHTML = `<tr><td colspan="9" class="text-center py-8 text-red-500">${escapeHtml(err.message || 'Gagal memuat')}</td></tr>`;
        activeBatch.textContent = '— error —';
        countBatch.textContent = '0';
      }
    }

    function renderQuestions(rows){
      if(!rows || rows.length === 0){
        questionsBody.innerHTML = `<tr><td colspan="9" class="text-center py-8 text-slate-400">Belum ada soal dalam batch ini.</td></tr>`;
        countBatch.textContent = '0';
        return;
      }
      countBatch.textContent = String(rows.length);
      questionsBody.innerHTML = rows.map((r, idx) => {
        const opts = r.options || {};
        const created = new Date(r.created_at || r.updated_at || Date.now()).toLocaleString('id-ID');
        return `
          <tr class="border-b">
            <td class="px-3 py-2 text-xs text-slate-500">${idx+1}</td>
            <td class="px-3 py-2 text-xs text-slate-400">${created}</td>
            <td class="px-3 py-2">${escapeHtml(r.question_text || '')}</td>
            <td class="px-3 py-2">${escapeHtml(opts.A || '')}</td>
            <td class="px-3 py-2">${escapeHtml(opts.B || '')}</td>
            <td class="px-3 py-2">${escapeHtml(opts.C || '')}</td>
            <td class="px-3 py-2">${escapeHtml(opts.D || '')}</td>
            <td class="px-3 py-2 font-semibold">${escapeHtml(r.correct_answer || '')}</td>
            <td class="px-3 py-2 text-right">
              <button class="btn-edit text-blue-600 px-3 py-1 rounded-md" data-id="${r.id}">Edit</button>
              <button class="btn-delete text-red-600 px-3 py-1 rounded-md ml-2" data-id="${r.id}">Hapus</button>
            </td>
          </tr>
        `;
      }).join('');
      // attach handlers
      document.querySelectorAll('.btn-edit').forEach(b => b.addEventListener('click', () => startEdit(b.dataset.id)));
      document.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', () => confirmDelete(b.dataset.id)));
    }

    // Submit form (create or update)
    quizForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      formMessage.textContent = '';

      const batch = batchIdInput.value.trim();
      if(!batch){ alert('Batch ID wajib diisi.'); return; }
      const qtext = questionText.value.trim();
      if(!qtext){ alert('Pertanyaan tidak boleh kosong.'); return; }

      const options = { A: optA.value.trim(), B: optB.value.trim(), C: optC.value.trim(), D: optD.value.trim() };
      const corr = correctAns.value;
      if(!['A','B','C','D'].includes(corr)){ alert('Pilih jawaban benar.'); return; }

      // prepare payload
      const payload = { batch_id: batch, question_text: qtext, options, correct_answer: corr, correct_text: options[corr] || null };

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = editMode ? 'Updating...' : 'Menyimpan...';

        if(editMode && editId){
          // update
          const { error } = await supabase
            .from('dashboard_quiz_questions')
            .update({ ...payload, updated_at: new Date().toISOString() })
            .eq('id', editId);
          if(error) throw error;
          formMessage.textContent = 'Berhasil diperbarui.';
        } else {
          // insert
          const { error } = await supabase
            .from('dashboard_quiz_questions')
            .insert([payload]);
          if(error) throw error;
          formMessage.textContent = 'Soal tersimpan.';
        }

        // reload batch
        await fetchBatch(batch);
        resetForm();
        // keep batch in input for convenience
        batchIdInput.value = batch;
      } catch(err){
        console.error(err);
        alert('Gagal simpan: ' + (err.message || err));
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Simpan Soal';
      }
    });

    // Reset form
    resetFormBtn.addEventListener('click', () => {
      resetForm();
    });

    // Start edit: load question into form
    async function startEdit(id){
      try {
        const { data, error } = await supabase
          .from('dashboard_quiz_questions')
          .select('id, batch_id, question_text, options, correct_answer')
          .eq('id', id)
          .single();
        if(error) throw error;
        // fill form
        batchIdInput.value = data.batch_id || batchIdInput.value;
        loadedBatch = data.batch_id || loadedBatch;
        activeBatch.textContent = loadedBatch || '—';
        questionText.value = data.question_text || '';
        const ops = data.options || {};
        optA.value = ops.A || '';
        optB.value = ops.B || '';
        optC.value = ops.C || '';
        optD.value = ops.D || '';
        correctAns.value = data.correct_answer || '';
        editMode = true;
        editId = data.id;
        submitBtn.textContent = 'Update Soal';
        // scroll to form top (mobile)
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch(err){
        console.error(err);
        alert('Gagal load soal untuk edit: ' + (err.message || err));
      }
    }

    // Confirm & delete
    async function confirmDelete(id){
      if(!confirm('Hapus soal ini? Tindakan tidak dapat dikembalikan.')) return;
      try {
        const { error } = await supabase
          .from('dashboard_quiz_questions')
          .delete()
          .eq('id', id);
        if(error) throw error;
        // refresh batch
        if(loadedBatch) await fetchBatch(loadedBatch);
      } catch(err){
        console.error(err);
        alert('Gagal hapus: ' + (err.message || err));
      }
    }

    // On load: if batchId prefilled, try load
    document.addEventListener('DOMContentLoaded', async () => {
      // keep empty by default, user can Generate
      // but if someone pastes batch in URL hash, prefill
      const hash = (location.hash || '').replace('#','');
      if(hash){
        batchIdInput.value = decodeURIComponent(hash);
        loadedBatch = batchIdInput.value;
        activeBatch.textContent = loadedBatch;
        await fetchBatch(loadedBatch);
      }
    });

    // Optional: allow pressing Enter to load batch when focus on batch input (mobile UX)
    batchIdInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){ e.preventDefault(); loadBatchBtn.click(); }
    });

    // small accessibility: allow tapping row to edit (optional)
    // (not necessary but improves UX)
    // Delegated event: if click cell not on button, try open edit if id present
    questionsBody.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button');
      if(btn) return; // button handled elsewhere
      const row = ev.target.closest('tr');
      if(!row) return;
      const editBtn = row.querySelector('.btn-edit');
      if(editBtn) editBtn.click();
    });

  </script>
</body>
</html>