<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profil Admin - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .btn-transition { transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out; }
    .btn-transition:active { transform: scale(0.98); }

    /* Lencana SUPER ADMIN yang Mewah */
    #role-display {
        /* Background dengan gradien mewah */
        background: linear-gradient(135deg, #FFD700, #DAA520, #B8860B);
        
        /* Warna teks putih untuk kontras yang kuat */
        color: #FFFFFF;

        /* Bayangan teks untuk efek timbul */
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);

        /* Bentuk pil dan padding */
        padding: 6px 16px;
        border-radius: 9999px; /* Tailwind's rounded-full */

        /* Bayangan kotak yang elegan */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);

        /* Gaya font dan ukuran */
        font-size: 0.875rem; /* Tailwind's text-sm */
        font-weight: 700;    /* Tailwind's font-bold */
        text-transform: uppercase;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-gray-800 dark:text-gray-200">

  <nav class="flex justify-between items-center bg-white dark:bg-slate-800 text-slate-800 dark:text-white px-6 py-4 shadow-md sticky top-0 z-10">
    <div>
      <a href=".">
        <span class="text-xl font-bold">Profil Admin</span>
      </a>
    </div>
    <button onclick="history.back()" class="bg-gray-200 dark:bg-slate-700 p-2 rounded-full hover:bg-gray-300 dark:hover:bg-slate-600">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
    </button>
  </nav>

  <main class="mx-auto px-4 py-10 w-full max-w-2xl">
    <div id="profile-container" class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 sm:p-8">
      <div class="flex flex-col items-center text-center">
        <div id="profile-photo-wrapper" class="relative cursor-pointer group">
          <div id="profile-initial" class="w-28 h-28 bg-blue-500 text-white flex items-center justify-center rounded-full text-5xl font-bold mb-4 border-4 border-white dark:border-slate-700">?</div>
          <img id="profile-photo" src="" alt="Foto Profil" class="hidden w-28 h-28 rounded-full object-cover border-4 border-white dark:border-slate-700 mb-4" />
          <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 rounded-full flex items-center justify-center transition-opacity">
            <span class="text-white text-sm opacity-0 group-hover:opacity-100">Ganti Foto</span>
          </div>
        </div>

        <p id="role-display" class="bg-cyan-100 text-cyan-800 text-sm font-semibold px-3 py-1 rounded-full -mt-2 mb-4 dark:bg-cyan-900 dark:text-cyan-200">Memuat...</p>

        <h2 id="username-display" class="text-3xl font-bold">Memuat...</h2>
      </div>

      <div class="mt-8 border-t dark:border-gray-700 pt-6">
        <h3 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">Detail Admin</h3>
        <ul class="space-y-4">
          <li class="flex items-center">
            <svg class="w-6 h-6 text-gray-400 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
            <span id="email-display" class="text-gray-600 dark:text-gray-400">Memuat...</span>
          </li>
          <li class="flex items-center">
            <svg class="w-6 h-6 text-gray-400 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span class="text-gray-600 dark:text-gray-400">Terakhir Aktif: <b id="last-active-display">Memuat...</b></span>
          </li>
        </ul>
      </div>

      <div id="auth-buttons" class="mt-8 pt-6 border-t dark:border-gray-700 flex flex-col sm:flex-row gap-4"></div>
    </div>

    <div id="login-prompt" class="hidden text-center bg-white dark:bg-slate-800 rounded-xl shadow-lg p-8">
        <h2 class="text-2xl font-bold mb-2">Anda Belum Masuk</h2>
        <p class="text-gray-500 dark:text-gray-400 mb-6">Silakan masuk untuk melihat halaman profil Anda.</p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="../daftar/" class="w-full sm:w-auto px-6 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 btn-transition text-center">Daftar</a>
            <a href="../masuk/" class="w-full sm:w-auto px-6 bg-gray-200 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-300 btn-transition text-center">Masuk</a>
        </div>
    </div>
  </main>

  <footer class="text-center py-6 text-gray-500 mt-10">
    <p>&copy; 2025 Belajar Ngaji - Semua Hak Dilindungi</p>
  </footer>

  <div id="avatar-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 w-96 text-center relative">
      <button id="close-modal" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 dark:hover:text-red-400">âœ•</button>
      <img id="preview" src="" alt="Pratinjau Foto" class="w-40 h-40 rounded-full object-cover border-4 border-gray-200 dark:border-slate-700 mx-auto mb-4" />
      <input type="file" id="avatarInput" accept="image/*" class="mb-4 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
      <button id="uploadBtn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 btn-transition">Upload Foto Baru</button>
    </div>
  </div>

  <script type="module">
    const { createClient } = supabase;
    const SUPABASE_URL = "https://jpxtbdawajjyrvqrgijd.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpweHRiZGF3YWpqeXJ2cXJnaWpkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjMxMjg5OCwiZXhwIjoyMDcxODg4ODk4fQ.1-CFqhW0mXPyv8jFyd-sa4m2FoCkyY4LbgiKGIKwb6I";
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- Mengambil elemen DOM ---
    const elements = {
        profileContainer: document.getElementById("profile-container"),
        loginPrompt: document.getElementById("login-prompt"),
        profileInitial: document.getElementById("profile-initial"),
        profilePhoto: document.getElementById("profile-photo"),
        usernameDisplay: document.getElementById("username-display"),
        roleDisplay: document.getElementById("role-display"),
        emailDisplay: document.getElementById("email-display"),
        lastActiveDisplay: document.getElementById("last-active-display"),
        authButtons: document.getElementById("auth-buttons"),
        modal: document.getElementById("avatar-modal"),
        closeModalBtn: document.getElementById("close-modal"),
        preview: document.getElementById("preview"),
        avatarInput: document.getElementById("avatarInput"),
        uploadBtn: document.getElementById("uploadBtn")
    };

    let currentUser = null;

    // --- Konstanta dan Inisialisasi Halaman ---
    const IS_DEVELOPMENT = true;
    const DEV_USER_ID = "f9874e8c-4a27-4b27-8e71-66f611349218";

    async function initializeProfilePage() {
      if (IS_DEVELOPMENT) {
        console.warn("MODE PENGEMBANGAN AKTIF. Menggunakan ID statis.");
        elements.profileContainer.classList.remove("hidden");
        elements.loginPrompt.classList.add("hidden");
        await loadAdminProfile(DEV_USER_ID);
        setupActionButtons();
      } else {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
          currentUser = user;
          await loadAdminProfile(user.id);
          setupActionButtons();
        } else {
          showLoginPrompt();
        }
      }
    }

    async function loadAdminProfile(userId) {
      const { data: admin, error } = await supabaseClient
        .from("admins_view")
        .select("*")
        .eq("id", userId)
        .maybeSingle();

      if (error) {
        console.error("Gagal memuat profil admin:", error.message);
        elements.usernameDisplay.textContent = "Gagal Memuat Profil";
        elements.roleDisplay.textContent = "-";
        elements.emailDisplay.textContent = "-";
        return;
      }

      if (admin) {
        elements.usernameDisplay.textContent = admin.username || "Username tidak diatur";
        elements.roleDisplay.textContent = admin.role || "Role tidak diatur";
        elements.emailDisplay.textContent = admin.email || "-";
        
        elements.lastActiveDisplay.textContent = admin.last_sign_in_at 
            ? new Date(admin.last_sign_in_at).toLocaleString("id-ID", { dateStyle: 'medium', timeStyle: 'short' })
            : "Tidak diketahui";

        if (admin.avatar_url) {
          elements.profilePhoto.src = admin.avatar_url;
          elements.preview.src = admin.avatar_url;
          elements.profilePhoto.classList.remove("hidden");
          elements.profileInitial.classList.add("hidden");
        } else {
          elements.profileInitial.textContent = (admin.username || "?").charAt(0).toUpperCase();
          elements.profilePhoto.classList.add("hidden");
          elements.profileInitial.classList.remove("hidden");
        }
      } else {
        elements.usernameDisplay.textContent = "Profil tidak ditemukan";
        elements.roleDisplay.textContent = "-";
        elements.emailDisplay.textContent = "-";
        elements.lastActiveDisplay.textContent = "-";
      }
    }

    function setupActionButtons() {
      elements.authButtons.innerHTML = `
        <button id="edit-profile-button" class="w-full sm:w-auto flex-1 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 btn-transition">Edit Profil</button>
        <button id="change-password-button" class="w-full sm:w-auto flex-1 bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 dark:bg-slate-700 dark:text-white dark:hover:bg-slate-600 btn-transition">Ganti Kata Sandi</button>
        <button id="logout-button" class="w-full sm:w-auto bg-red-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-600 btn-transition">Keluar</button>
      `;
      
      if (!IS_DEVELOPMENT) {
          document.getElementById("logout-button").addEventListener("click", async () => {
            await supabaseClient.auth.signOut();
            window.location.href = "../../masuk/";
          });
      }
    }

    function showLoginPrompt() {
      elements.profileContainer.classList.add("hidden");
      elements.loginPrompt.classList.remove("hidden");
    }

    async function uploadAvatar(file, userId) {
      if (!file) {
        alert("Pilih file yang akan diunggah.");
        return;
      }

      elements.uploadBtn.disabled = true;
      elements.uploadBtn.textContent = "Mengunggah...";

      const fileName = `${userId}_${Date.now()}`;
      const { error: uploadError } = await supabaseClient.storage
        .from("avatars")
        .upload(fileName, file, { upsert: true });

      if (uploadError) {
        console.error(uploadError);
        alert("Unggah gagal: " + uploadError.message);
        elements.uploadBtn.disabled = false;
        elements.uploadBtn.textContent = "Unggah Foto Baru";
        return;
      }

      const { data } = supabaseClient.storage.from("avatars").getPublicUrl(fileName);
      const publicUrl = data.publicUrl;

      const { error: updateError } = await supabaseClient
        .from("profiles")
        .update({ avatar_url: publicUrl })
        .eq("id", userId);

      if (updateError) {
        console.error(updateError);
        alert("Gagal memperbarui URL avatar di profil.");
      } else {
        elements.profilePhoto.src = publicUrl;
        elements.preview.src = publicUrl;
        elements.profilePhoto.classList.remove("hidden");
        elements.profileInitial.classList.add("hidden");
        elements.modal.classList.add("hidden");
      }
      elements.uploadBtn.disabled = false;
      elements.uploadBtn.textContent = "Unggah Foto Baru";
    }

    // --- Event Listener ---
    elements.profilePhoto.addEventListener("click", () => {
      if (IS_DEVELOPMENT || currentUser) {
        elements.modal.classList.remove("hidden");
        elements.modal.classList.add("flex");
      }
    });

    elements.closeModalBtn.addEventListener("click", () => {
      elements.modal.classList.add("hidden");
      elements.modal.classList.remove("flex");
    });

    elements.uploadBtn.addEventListener("click", async () => {
      const file = elements.avatarInput.files[0];
      const userId = IS_DEVELOPMENT ? DEV_USER_ID : (currentUser ? currentUser.id : null);
      if (userId) {
        await uploadAvatar(file, userId);
      }
    });

    // Jalankan saat DOM siap
    document.addEventListener("DOMContentLoaded", initializeProfilePage);
  </script>
</body>
</html>