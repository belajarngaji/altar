<!DOCTYPE html>
<html lang="id" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profil Admin - Belajar Ngaji</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

  <!-- Navigasi yang konsisten -->
  <nav class="flex justify-between items-center bg-white dark:bg-slate-800/50 dark:backdrop-blur-sm px-6 py-4 shadow-md sticky top-0 z-10 border-b border-gray-200 dark:border-slate-700">
    <div>
      <a href="./">
        <span class="text-xl font-bold text-gray-800 dark:text-white">Profil Administrator</span>
      </a>
    </div>
    <a href="../ruang" 
      class="bg-gray-100 dark:bg-white/10 text-blue-600 dark:text-white p-2 rounded-full hover:bg-gray-200 dark:hover:bg-white/20 transition-colors"
      title="Kembali ke Dashboard">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" />
      </svg>
    </a>
  </nav>

  <main class="mx-auto px-4 py-10 w-full max-w-2xl">
    <!-- Tampilan Profil Admin -->
    <div id="admin-profile-view" class="hidden">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 sm:p-8 border border-gray-200 dark:border-slate-700">
            <div class="flex flex-col sm:flex-row items-center sm:items-start text-center sm:text-left gap-6 border-b pb-6 dark:border-gray-700">

                <div class="flex flex-col items-center flex-shrink-0">
                    <div id="profile-photo-wrapper" class="relative cursor-pointer" title="Klik untuk ubah foto">
                        <div id="profile-initial" class="w-24 h-24 bg-blue-500 text-white flex items-center justify-center rounded-full text-4xl font-bold">?</div>
                        <img id="profile-photo" src="" alt="Foto Profil" class="hidden w-24 h-24 rounded-full object-cover border-2 border-white dark:border-slate-600 shadow-md" />
                    </div>
                    <div id="super-admin-badge" class="hidden mt-2 px-3 py-1 bg-gradient-to-r from-yellow-400 to-amber-500 text-white text-xs font-bold rounded-full shadow-lg transform hover:scale-105 transition-transform">
                        ✨ Super Admin
                    </div>
                </div>

                <div class="flex-grow">
                    <h2 id="username-display" class="text-3xl font-bold">Memuat...</h2>
                    <p id="role-display" class="text-blue-500 dark:text-blue-400 font-semibold mt-1 capitalize">Memuat role...</p>
                    <p id="email-display" class="text-gray-500 dark:text-gray-400 mt-2">memuat email...</p>
                </div>
            </div>

            <div class="mt-6">
                <h3 class="text-xl font-semibold mb-4">Aksi Cepat</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <a href="../ruang/management/" class="flex items-center gap-3 p-4 bg-gray-50 dark:bg-slate-700 hover:bg-gray-100 dark:hover:bg-slate-600 rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-blue-500"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span class="font-semibold">Koreksi Jawaban</span>
                    </a>
                    <a href="../ruang/harian/" class="flex items-center gap-3 p-4 bg-gray-50 dark:bg-slate-700 hover:bg-gray-100 dark:hover:bg-slate-600 rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-green-500"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        <span class="font-semibold">Buat Tantangan Baru</span>
                    </a>
                    <a href="../ruang/users/" class="flex items-center gap-3 p-4 bg-gray-50 dark:bg-slate-700 hover:bg-gray-100 dark:hover:bg-slate-600 rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-purple-500"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.67c.12-.318.239-.636.354-.961" /></svg>
                        <span class="font-semibold">Kelola Pengguna</span>
                    </a>
                    <a href="../ruang/riwayat/" class="flex items-center gap-3 p-4 bg-gray-50 dark:bg-slate-700 hover:bg-gray-100 dark:hover:bg-slate-600 rounded-lg transition-colors">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-yellow-500"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h12A2.25 2.25 0 0020.25 14.25V3.75M3.75 3h-1.5m1.5 0h16.5m-16.5 0h16.5M3.75 6h16.5M3.75 9h16.5M3.75 12h16.5m-16.5 3.75h16.5M3.75 3.75h16.5" /></svg>
                        <span class="font-semibold">Riwayat Tantangan</span>
                    </a>
                </div>
            </div>

            <div id="auth-buttons" class="mt-8 pt-6 border-t dark:border-gray-700 flex flex-col sm:flex-row gap-4">
            </div>
        </div>
    </div>

  </main>

  <footer class="text-center py-6 dark:text-gray-500 mt-10">
    <p>&copy; 2025 Belajar Ngaji - Semua Hak Dilindungi</p>
  </footer>

  <!-- Modal untuk ganti foto profil -->
  <div id="avatar-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4">
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 w-full max-w-md text-center relative border border-gray-200 dark:border-slate-700">
      <h3 class="text-xl font-semibold mb-4">Ubah Foto Profil</h3>
      <button id="close-modal" class="absolute top-3 right-4 text-gray-500 hover:text-red-600 dark:hover:text-red-400 text-2xl">×</button>
      <img id="preview" src="" alt="Pratinjau Foto" class="w-40 h-40 rounded-full object-cover border-2 dark:border-slate-600 mx-auto mb-4" />
      <input type="file" id="avatarInput" accept="image/*" class="mb-4 w-full text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-blue-900/50 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-100 dark:hover:file:bg-blue-900"/>
      <button id="uploadBtn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-transform active:scale-95 disabled:bg-blue-800">Upload & Simpan</button>
    </div>
  </div>

  <script type="module">
    const { createClient } = supabase;
    const SUPABASE_URL = "https://jpxtbdawajjyrvqrgijd.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpweHRiZGF3YWpqeXJ2cXJnaWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTI4OTgsImV4cCI6MjA3MTg4ODg5OH0.vEqCzHYBByFZEXeLIBqx6b40x6-tjSYa3Il_b2mI9NE";
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    // DOM Elements
    const adminProfileView = document.getElementById("admin-profile-view");
    const profileInitial = document.getElementById("profile-initial");
    const profilePhoto = document.getElementById("profile-photo");
    const usernameDisplay = document.getElementById("username-display");
    const emailDisplay = document.getElementById("email-display");
    const roleDisplay = document.getElementById("role-display");
    const superAdminBadge = document.getElementById("super-admin-badge");
    const authButtons = document.getElementById("auth-buttons");
    const modal = document.getElementById("avatar-modal");
    const closeModalBtn = document.getElementById("close-modal");
    const preview = document.getElementById("preview");
    const avatarInput = document.getElementById("avatarInput");
    const uploadBtn = document.getElementById("uploadBtn");

    let currentUser = null;

    async function initializeProfilePage() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
          currentUser = user;
          await loadUserProfile(user.id, user.email);
        } else {
          adminProfileView.classList.add("hidden");
          console.warn("Pengguna belum masuk. Data profil tidak akan ditampilkan.");
        }
      } catch (error) {
        console.error("Gagal menginisialisasi halaman:", error);
        adminProfileView.classList.add("hidden");
      }
    }

    async function loadUserProfile(userId, userEmail) {
      const { data: adminData, error } = await supabaseClient
        .from('admins_view')
        .select('username, avatar_url, role_name')
        .eq('id', userId)
        .maybeSingle();

      if (adminData) {
        adminProfileView.classList.remove("hidden");
        setupActionButtons();

        usernameDisplay.textContent = adminData.username || 'Nama Pengguna';
        emailDisplay.textContent = userEmail; 
        roleDisplay.textContent = adminData.role_name || 'Role Tidak Ditetapkan';

        if (adminData.role_name && adminData.role_name.toLowerCase() === 'super admin') {
          superAdminBadge.classList.remove('hidden');
        } else {
          superAdminBadge.classList.add('hidden');
        }

        if (adminData.avatar_url) {
          const publicURL = `${adminData.avatar_url}?t=${new Date().getTime()}`;
          profilePhoto.src = publicURL;
          preview.src = publicURL;
          profilePhoto.classList.remove("hidden");
          profileInitial.classList.add("hidden");
        } else {
          profileInitial.textContent = adminData.username ? adminData.username.charAt(0).toUpperCase() : '?';
          profilePhoto.classList.add("hidden");
          profileInitial.classList.remove("hidden");
        }
      } else {
        console.error("Akses ditolak. Pengguna bukan admin. Error:", error?.message);
        await supabaseClient.auth.signOut();
        window.location.href = "/teras/admin/";
      }
    }

    function setupActionButtons() {
      authButtons.innerHTML = `
        <button id="change-password-button" class="w-full sm:w-auto flex-1 bg-gray-200 hover:bg-gray-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-gray-800 dark:text-gray-200 font-bold py-3 rounded-lg transition">Ubah Kata Sandi</button>
        <button id="logout-button" class="w-full sm:w-auto flex-1 bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition">Keluar</button>
      `;
      document.getElementById("logout-button").addEventListener("click", async () => {
        await supabaseClient.auth.signOut();
        window.location.href = "/teras/admin/";
      });
      document.getElementById("change-password-button").addEventListener("click", () => {
        alert("Fitur ubah kata sandi akan segera tersedia.");
      });
    }

    async function uploadAvatar(file, userId) {
      if (!file) return;

      uploadBtn.disabled = true;
      uploadBtn.textContent = "Mengunggah...";

      const fileName = `public/${userId}`; 
      const { error } = await supabaseClient.storage
        .from("avatars")
        .upload(fileName, file, { upsert: true });

      if (error) {
        console.error(error);
        alert("Upload gagal: " + error.message);
      } else {
        const { data } = supabaseClient.storage.from("avatars").getPublicUrl(fileName);
        const { error: updateError } = await supabaseClient
          .from("profiles")
          .update({ avatar_url: data.publicUrl })
          .eq("id", userId);

        if (updateError) {
          console.error(updateError);
          alert("Gagal memperbarui URL avatar di profil.");
        } else {
          await loadUserProfile(userId, currentUser.email);
          modal.classList.add("hidden");
        }
      }
      uploadBtn.disabled = false;
      uploadBtn.textContent = "Upload & Simpan";
    }

    // --- Event Listeners ---
    document.getElementById("profile-photo-wrapper").addEventListener("click", () => {
      if (!currentUser) return;
      avatarInput.value = '';
      preview.src = profilePhoto.src || `https://placehold.co/160x160/334155/E2E8F0?text=${usernameDisplay.textContent.charAt(0)}`;
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    });

    closeModalBtn.addEventListener("click", () => {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    });

    avatarInput.addEventListener('change', (event) => {
        if (event.target.files && event.target.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => preview.src = e.target.result;
            reader.readAsDataURL(event.target.files[0]);
        }
    });

    uploadBtn.addEventListener("click", async () => {
      const file = avatarInput.files[0];
      if (currentUser && file) {
        await uploadAvatar(file, currentUser.id);
      }
    });

    document.addEventListener("DOMContentLoaded", initializeProfilePage);
  </script>
</body>
</html>